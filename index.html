<!DOCTYPE html>
<html>
  <head>
    <title>MailAider AI 4.0</title>
    <meta charset="UTF-8" />
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script
      src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs"
      type="module"
    ></script>

    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        line-height: 1.5; font-weight: 400; color: #333;
        background: #fff; padding: 0.25rem; max-width: 350px; margin: 0 auto;
        transition: background 0.3s, color 0.3s;
      }
      .dark-mode {
        background: linear-gradient(135deg,#2c2f33 0%,#1a1d23 100%); 
        color:#e0e0e0;
      }
      .container {
        background: rgba(255,255,255,0.8); border:1px solid #ccc; 
        border-radius:8px; padding:0.5rem;
      }
      .dark-mode .container {
        background: rgba(44,47,51,0.9); border-color:#4a4e57;
      }
      .header {
        display:flex; align-items:center; position:relative;
        padding:0.5rem; border-bottom:1px solid #ccc;
      }
      .dark-mode .header {
        border-bottom-color:#4a4e57;
      }
      .logo { width:30px; height:auto; margin-right:0.5rem; }
      .main-heading {
        font-family:"Franklin Gothic Medium","Arial Narrow",Arial,sans-serif;
        font-size:1.4rem; font-weight:800; letter-spacing:-0.02em; 
        color:#1e90ff;
      }
      .dark-mode .main-heading { color:#87cefa; }
      .header dotlottie-player { margin-left:0.5rem; }
      .dark-mode-toggle {
        position:absolute; top:0.5rem; right:0.5rem; font-size:1.2rem;
        cursor:pointer; color:#1e90ff; background:none; border:none;
      }
      .dark-mode .dark-mode-toggle { color:#87cefa; }

      /* Privacy Notice */
      .privacy-notice {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 10px 15px;
        border-radius: 16px;
        font-size: 14px;
        margin: 10px auto;
        width: fit-content;
        background: rgba(0, 0, 0, 0.05);
        color: #333;
      }
      .dark-mode .privacy-notice {
        background: rgba(255, 255, 255, 0.1);
        color: #e0e0e0;
      }
      .privacy-lottie {
        width: 24px !important;
        height: 24px !important;
      }

      .error {
        color:#ff6b6b; font-size:0.85rem; margin:0.5rem 0;
        padding:0.25rem; background:rgba(255,107,107,0.1);
        border-radius:4px; display:none;
      }
      .error.active { display:block; }
      .dark-mode .error { background:rgba(255,107,107,0.2); }

      .email-viewer, .output-container, .input-container {
        padding:0.5rem; margin:0.5rem 0;
        background:rgba(255,255,255,0.1); border-radius:8px;
        border:1px solid #ccc; box-shadow:0 3px 15px rgba(0,0,0,0.1);
      }
      .dark-mode .email-viewer,
      .dark-mode .output-container,
      .dark-mode .input-container {
        background:rgba(34,37,41,0.7); border-color:#4a4e57;
        box-shadow:0 3px 15px rgba(0,240,255,0.1);
      }

      .email-header { padding-bottom:0.5rem; border-bottom:1px solid #ccc; }
      .dark-mode .email-header { border-bottom-color:#4a4e57; }
      .email-header h2 { font-weight:700; color:#333; font-size:1rem; }
      .dark-mode .email-header h2 { color:#e0e0e0; }
      .email-header p { color:#666; font-size:0.85rem; margin:0; }
      .dark-mode .email-header p { color:#a0a0a0; }

      .email-body {
        margin-top:0.5rem; line-height:1.6; color:#333; font-size:0.85rem;
        white-space:pre-wrap; background:rgba(255,255,255,0.05);
        padding:0.5rem; border-radius:6px; border:1px solid rgba(255,255,255,0.05);
        height:200px; overflow-y:auto; display:none;
      }
      .email-body.active { display:block; }
      .dark-mode .email-body {
        color:#e0e0e0; background:rgba(40,44,52,0.5); border-color:#4a4e57;
      }

      .summary {
        margin-top:0.5rem; line-height:1.6; color:#333; font-size:0.85rem;
        white-space:pre-wrap; background:rgba(255,255,255,0.05);
        padding:0.5rem; border-radius:6px; border:1px solid rgba(255,255,255,0.05);
        display:none;
      }
      .dark-mode .summary { color:#e0e0e0; background:rgba(40,44,52,0.5); border-color:#4a4e57; }

      .send-button {
        background:#1e90ff; color:#fff; border:none; padding:0.5rem 1rem;
        font-size:0.95rem; cursor:pointer; width:100%; margin-top:0.5rem;
        transition:background 0.2s ease;
      }
      .send-button:disabled { cursor:not-allowed; background:rgba(0,0,0,0.3); }
      .send-button:hover:not(:disabled) { background:#00ff7f; }
      .dark-mode .send-button { background:#1e90ff; }
      .dark-mode .send-button:hover:not(:disabled) { background:#00ff7f; }

      .action-buttons {
        display:flex; justify-content:space-between; margin:0.5rem 0;
        padding:0.5rem; background:rgba(255,255,255,0.1);
        border:1px solid #ccc; border-radius:8px;
      }
      .dark-mode .action-buttons { background:rgba(34,37,41,0.7); }

      .action-button {
        flex:1; text-align:center; padding:0.5rem; font-size:1.5rem;
        border:none; background:none; color:#1e90ff; cursor:pointer;
        position:relative; border-right:1px solid #ccc;
      }
      .action-button:last-child { border-right:none; }
      .action-button:hover::after {
        content:attr(data-tooltip); position:absolute; top:-2.5rem;
        left:50%; transform:translateX(-50%);
        background:#1e90ff; color:#fff; padding:0.25rem 0.5rem;
        border-radius:4px; font-size:0.8rem; white-space:nowrap;
      }
      .dark-mode .action-button { color:#87cefa; }
      .action-button:hover { color:#00ff7f; }

      .output-container { position:relative; height:250px; overflow-y:auto; }
      #lottieLoader {
        display:none; width:120px; height:120px; margin:1rem auto;
      }
      #output {
        white-space:pre-wrap; line-height:1.6; color:#333; font-size:0.85rem;
      }
      .dark-mode #output { color:#e0e0e0; }

      .copy-button {
        position:sticky; bottom:0.5rem; right:0.5rem;
        background:rgba(255,255,255,0.1); border:1px solid #ccc; border-radius:4px;
        padding:0.25rem; font-size:0.9rem; color:#1e90ff; cursor:pointer;
        z-index:10;
      }
      .copy-button:hover { background:rgba(255,255,255,0.2); color:#00ff7f; }
      .dark-mode .copy-button { color:#87cefa; }

      .input-container textarea {
        width:100%; box-sizing:border-box; resize:vertical;
        min-height:100px; padding:5px; font-family:"Inter",sans-serif;
        background:#fff; border:1px solid rgba(104,104,104,0.65);
        border-radius:5px; color:#000;
      }
      .dark-mode .input-container textarea {
        background:#2d2d2d; border-color:#4a4e57; color:#e0e0e0;
      }
      .input-container textarea:focus { outline:1px solid rgba(0,0,0,0.7); }
      .dark-mode .input-container textarea:focus { outline:1px solid #87cefa; }

      .settings-modal {
        position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
        background:#fff; padding:1.5rem; border-radius:12px;
        box-shadow:0 4px 6px rgba(0,0,0,0.1); display:none; z-index:2000;
        min-width:300px; max-width:90%;
      }
      .dark-mode .settings-modal {
        background:linear-gradient(135deg,#2c2f33 0%,#1a1d23 100%);
        box-shadow:0 4px 6px rgba(0,0,0,0.3);
      }
      .settings-modal.active { display:block; }
      .form-group { margin-bottom:0.75rem; }
      .form-group label { 
        display:block; margin-bottom:0.25rem; font-weight:600;
        color:#333;
      }
      .dark-mode .form-group label { color:#e0e0e0; }
      .form-group select {
        width:100%; padding:0.5rem; border:2px solid #ccc;
        border-radius:6px; font-size:0.9rem; background:#fff;
        color:#333;
      }
      .dark-mode .form-group select {
        background:#2d2d2d; border-color:#4a4e57; color:#e0e0e0;
      }
    </style>
  </head>

  <body>
    <!-- Popup -->
    <div id="customPopup" style="display:none;
         position:fixed;top:0;left:0;width:100%;height:100%;
         background:rgba(0,0,0,0.5);z-index:1000;
         justify-content:center;align-items:center;">
      <div style="background:white;padding:20px;border-radius:8px;
           max-width:80%;max-height:80%;overflow:auto;">
        <div id="popupContent"></div>
        <button onclick="hidePopup()"
                style="margin-top:15px;padding:5px 10px;
                       background:#1e90ff;color:white;
                       border:none;border-radius:4px;cursor:pointer;">
          Schließen
        </button>
      </div>
    </div>

    <div class="container">
      <div class="header">
        <img src="https://raw.githubusercontent.com/FlowEdgeSolutions/officeAddin/refs/heads/main/assets/logo80.png"
             alt="MailAider Logo" class="logo" />
        <h1 class="main-heading">MailAider AI 4.0</h1>
        <!-- Header Loading Lottie -->
        <dotlottie-player id="lottieHeaderLoading"
          src="https://lottie.host/ca615a42-7026-46ed-8ad3-5d1d3be3bee4/jRk8P0eZ6D.lottie"
          background="transparent" speed="1"
          style="width:40px;height:40px;display:none" loop autoplay>
        </dotlottie-player>
        <!-- Header Ready Lottie -->
        <dotlottie-player id="lottieHeaderReady"
          src="https://lottie.host/c92a8a5d-1a9b-4e79-968c-ccd370fdcbb3/K6ZUSuXQTS.lottie"
          background="transparent" speed="1"
          style="width:40px;height:40px;display:none" loop autoplay>
        </dotlottie-player>
        <button class="dark-mode-toggle" onclick="toggleDarkMode()">🌙</button>
      </div>

      <!-- Unternehmensdatenschutz Hinweis -->
      <div class="privacy-notice">
        <dotlottie-player
          class="privacy-lottie"
          src="https://lottie.host/ca615a42-7026-46ed-8ad3-5d1d3be3bee4/jRk8P0eZ6D.lottie"
          background="transparent"
          speed="1"
          loop
          autoplay
        ></dotlottie-player>
        <span>Unternehmensdatenschutz gilt für diesen Chat</span>
      </div>

      <div class="error" id="error"></div>

      <div class="email-viewer">
        <div class="email-header">
          <h2 id="emailSubject">Lade Betreff...</h2>
          <p id="emailSender">Lade Absender...</p>
        </div>
        <div class="summary" id="emailSummary">Lade Zusammenfassung...</div>
        <button class="send-button" id="toggleSummaryButton"
                onclick="toggleSummary()">Zusammenfassung anzeigen</button>
      </div>

      <div class="output-container">
        <dotlottie-player id="lottieLoader"
          src="https://lottie.host/c50dbde0-250a-43a1-8493-de801fb3caf5/zs2kPt4Uv9.lottie"
          background="transparent" speed="1"
          style="display:none" loop autoplay>
        </dotlottie-player>
        <div id="output">Warte auf Ausgabe...</div>
        <button class="copy-button" onclick="copyOutputContent()">📋</button>
      </div>

      <div class="input-container">
        <textarea id="promptInput"
                  placeholder="Was soll verarbeitet werden? (optional)"
                  rows="4"></textarea>
        <button class="send-button" id="actionButton"
                onclick="openSettings()" disabled>Lade...</button>
      </div>

      <div class="action-buttons">
        <button class="action-button" data-tooltip="Zusammenfassen"
                onclick="setAction('zusammenfassen')">📝</button>
        <button class="action-button" data-tooltip="Antworten"
                onclick="setAction('antworten')">✉️</button>
        <button class="action-button" data-tooltip="Übersetzen"
                onclick="setAction('übersetzen')">🌐</button>
        <button class="action-button" data-tooltip="Freier Modus"
                onclick="setAction('freierModus')">🔧</button>
      </div>

      <div class="settings-modal" id="settingsModal">
        <div class="form-group">
          <label for="modeSelect">Verarbeitung:</label>
          <select id="modeSelect" onchange="updateSettings()">
            <option value="azure">⚡ Schnell (Azure)</option>
            <option value="ollama">🔒 Datenschutz (Ollama)</option>
          </select>
        </div>
        <div class="form-group" id="toneGroup" style="display:none">
          <label for="toneSelect">Tonfall:</label>
          <select id="toneSelect">
            <option value="formell">Formell</option>
            <option value="informell">Informell</option>
            <option value="höflich">Höflich</option>
            <option value="direkt">Direkt & prägnant</option>
          </select>
        </div>
        <div class="form-group" id="greetingGroup" style="display:none">
          <label for="greetingSelect">Anrede:</label>
          <select id="greetingSelect">
            <option value="informell">Du</option>
            <option value="formell">Sie</option>
          </select>
        </div>
        <div class="form-group" id="lengthGroup" style="display:none">
          <label for="lengthSelect">Länge:</label>
          <select id="lengthSelect">
            <option value="kurz">Kurz</option>
            <option value="mittel">Mittel</option>
            <option value="lang">Lang</option>
          </select>
        </div>
        <div class="form-group" id="languageGroup" style="display:none">
          <label for="languageSelect">Zielsprache:</label>
          <select id="languageSelect">
            <option value="deutsch">Deutsch</option>
            <option value="englisch">Englisch</option>
            <option value="französisch">Französisch</option>
            <option value="italienisch">Italienisch</option>
          </select>
        </div>
        <button class="send-button" onclick="handleSubmitFromModal()">Ausführen</button>
        <button class="send-button" onclick="closeSettings()">Schließen</button>
      </div>
    </div>

    <script>
      function showPopup(message) {
        const p = document.getElementById("customPopup");
        document.getElementById("popupContent").innerHTML = message;
        p.style.display = "flex";
      }
      function hidePopup() {
        document.getElementById("customPopup").style.display = "none";
      }

      const errorDiv = document.getElementById("error");
      const actionButton = document.getElementById("actionButton");
      const settingsModal = document.getElementById("settingsModal");
      const emailSummaryDiv = document.getElementById("emailSummary");
      const lottieLoader = document.getElementById("lottieLoader");
      const lottieHeaderLoading = document.getElementById("lottieHeaderLoading");
      const lottieHeaderReady = document.getElementById("lottieHeaderReady");
      const privacyLottie = document.querySelector(".privacy-lottie");

      let emailContent = "", emailSubject = "", emailSender = "";
      let mode="azure", action="antworten", tone="formell",
          language="deutsch", greeting="informell", length="kurz";
      let isContentLoaded=false;

      // Dark/Light Mode Funktionen
      function toggleDarkMode() {
        const isDarkMode = document.body.classList.toggle("dark-mode");
        const toggleBtn = document.querySelector(".dark-mode-toggle");
        toggleBtn.textContent = isDarkMode ? "☀️" : "🌙";
        
        // Lottie Animation wechseln
        if(privacyLottie) {
          privacyLottie.src = isDarkMode 
            ? "https://lottie.host/315e81ec-fb44-44fe-a9c5-bf08ce9bc46b/dnLhElwMXh.lottie"
            : "https://lottie.host/ca615a42-7026-46ed-8ad3-5d1d3be3bee4/jRk8P0eZ6D.lottie";
        }
      }

      function initTheme() {
        // Standardmäßig Light Mode
        document.body.classList.remove("dark-mode");
        document.querySelector(".dark-mode-toggle").textContent = "🌙";
        
        // Privacy Lottie initialisieren
        if(privacyLottie) {
          privacyLottie.src = "https://lottie.host/ca615a42-7026-46ed-8ad3-5d1d3be3bee4/jRk8P0eZ6D.lottie";
        }
      }

      function logError(msg) {
        console.error(msg);
        errorDiv.innerText = msg;
        errorDiv.classList.add("active");
      }
      
      function openSettings() {
        if (!isContentLoaded) return;
        settingsModal.classList.add("active");
        document.getElementById("modeSelect").value = mode;
        updateSettings();
      }
      
      function closeSettings() {
        settingsModal.classList.remove("active");
      }
      
      function mapLanguage(l) {
        const m={deutsch:"German",englisch:"English",französisch:"French",italienisch:"Italian"};
        return m[l]||l;
      }
      
      function setAction(a) {
        action=a;
        actionButton.textContent = a==="zusammenfassen"?"Zusammenfassen":
                                  a==="antworten"?"Antwort formulieren":
                                  a==="übersetzen"?"Übersetzen":"Freier Modus";
        if(isContentLoaded) actionButton.disabled=false;
        updateSettings();
      }
      
      function updateSettings() {
        mode=document.getElementById("modeSelect").value;
        document.getElementById("toneGroup").style.display = action==="antworten"?"block":"none";
        document.getElementById("greetingGroup").style.display = action==="antworten"?"block":"none";
        document.getElementById("lengthGroup").style.display = action==="antworten"?"block":"none";
        document.getElementById("languageGroup").style.display = action==="übersetzen"?"block":"none";
        if(action==="antworten"){
          tone=document.getElementById("toneSelect").value;
          greeting=document.getElementById("greetingSelect").value;
          length=document.getElementById("lengthSelect").value;
        } else if(action==="übersetzen"){
          language=mapLanguage(document.getElementById("languageSelect").value);
        }
      }
      
      function toggleSummary(){
        if(emailSummaryDiv.style.display==="none"){
          emailSummaryDiv.style.display="block";
          document.getElementById("toggleSummaryButton").innerText="Zusammenfassung verbergen";
        } else {
          emailSummaryDiv.style.display="none";
          document.getElementById("toggleSummaryButton").innerText="Zusammenfassung anzeigen";
        }
      }
      
      function copyOutputContent(){
        navigator.clipboard.writeText(document.getElementById("output").innerText).catch(()=>{});
      }

      async function callAzure(prompt){
        try {
          lottieLoader.style.display = "block";
          lottieHeaderLoading.style.display = "block";
          lottieHeaderReady.style.display = "none";
          
          const res = await fetch(
            "https://openaiaddinapi.openai.azure.com/openai/deployments/gpt-4o_MailAiderAi_OutlookAddIn/chat/completions?api-version=2025-01-01-preview", {
              method:"POST",
              headers:{
                "Content-Type":"application/json",
                "api-key":"9psvVslPXfp4xbJ9SzRXpfx9E9lP8TLiFcC3IZgf43RLNQA9RiV4JQQJ99BFACI8hq2XJ3w3AAABACOGHQcr"
              },
              body:JSON.stringify({
                messages:[
                  {role:"system",content:"Du bist ein E-Mail-Assistent. Verwende immer die Schweizer Rechtschreibung. Nutze den bereitgestellten E-Mail-Inhalt als Grundlage, sofern kein separater Benutzertext gegeben ist."},
                  {role:"user",content:prompt}
                ],
                temperature:0.6
              })
            }
          );
          const data = await res.json();
          return data.choices?.[0]?.message?.content || "❌ Keine Antwort erhalten.";
        } catch(e){
          return "❌ Fehler bei Azure: "+e.message;
        } finally {
          lottieLoader.style.display = "none";
          lottieHeaderLoading.style.display = "none";
          lottieHeaderReady.style.display = "block";
        }
      }
      
      async function callLokal(prompt){
        try {
          lottieLoader.style.display = "block";
          lottieHeaderLoading.style.display = "block";
          lottieHeaderReady.style.display = "none";
          
          const res = await fetch("http://localhost:11434/api/chat",{
            method:"POST", headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
              model:"nous-hermes2",
              messages:[
                {role:"system",content:"Rolle: Du bist ein professioneller E-Mail-Assistent. Nutze konsequent Schweizer Rechtschreibung. Bei Antworten beachte Tonalität, Anredeform und Textlänge gemäss Benutzervorgabe. Der Benutzertext hat Vorrang vor dem E-Mail-Inhalt."},
                {role:"user",content:prompt}
              ],
              stream:false
            })
          });
          const d = await res.json();
          return d.message?.content || "❌ Keine Antwort erhalten.";
        } catch(e){
          return "❌ Fehler bei Lokal: "+e.message;
        } finally {
          lottieLoader.style.display = "none";
          lottieHeaderLoading.style.display = "none";
          lottieHeaderReady.style.display = "block";
        }
      }

      async function handleSubmitFromModal(){
        const promptInput = document.getElementById("promptInput").value;
        const outputDiv = document.getElementById("output");
        
        if(!emailContent && !promptInput){
          outputDiv.innerText="❌ Kein E-Mail-Inhalt oder Benutzertext verfügbar.";
          return;
        }

        const emailText = emailContent ? `Kontext: ${emailContent}\n` : "";
        let fullPrompt = promptInput || "";
        
        if(action==="zusammenfassen"){
          fullPrompt = `Fasse den Inhalt der folgenden E-Mail in Stichpunkten zusammen. Nutze Anstatt Striche - Punkte ● prägnanten Stichpunkten zusammen. Die Zusammenfassung darf etwas ausführlicher sein, soll aber dennoch klar und strukturiert bleiben. Ziel ist es, dem Nutzer einen schnellen, aber umfassenden Überblick zu geben: Worum geht es? Welche Themen oder Anliegen werden genannt? Was sind wichtige Informationen oder nächste Schritte? \n\n${emailText}${promptInput}`;
        } else if(action==="antworten"){
          fullPrompt = `Formuliere eine Antwort auf die folgende E-Mail im ${tone} Ton mit ${greeting} Anrede (${length}) Sprachstil: Verwende durchgängig die Schweizer Rechtschreibung. Inhaltliche Grundlage: Nutze den bereitgestellten E-Mail-Inhalt als Ausgangspunkt, ausser es wird ein separater Benutzertext angegeben, dann hat dieser Vorrang. Begrüssung: Beginne die Antwort mit: „Hallo [Name des Absenders der ursprünglichen E-Mail]`. Wenn der Name des Absenders nicht erkannt werden kann, schreibe nur: „Hallo,". Grussformel: Lasse die Grussformel beim Beantworten von E-Mails aus. Tonalität: Parameter wie formell/informell sowie Sie/Du werden vom Benutzer angegeben. Richte Formulierung, Ansprache und Stil konsequent nach diesen Angaben aus. Formatierung: Lasse Betreff immer aus und bringe es nicht in die Antwort ein. Verzichte am Ende auf eine Grussformel.:\n${emailText}${promptInput}`;
        } else if(action==="übersetzen"){
          fullPrompt = `Übersetze den folgenden E-Mail-Inhalt vollständig und ausschließlich ins ${mapLanguage(language)}:\n${emailText}${promptInput}`;
        } else if(action==="freierModus"){
          fullPrompt = `${emailText}${promptInput}`;
        }

        closeSettings();
        const apiCall = mode==="azure"?callAzure:callLokal;
        const response = await apiCall(fullPrompt);
        outputDiv.innerText = response;
      }

      async function summarizeEmail(){
        if(!emailContent) return;
        const p = `Fasse den Inhalt der folgenden E-Mail in maximal 4 Stichpunkten und nicht in ganzen Sätzen. Nutze Anstatt Striche - Punkte ● prägnanten Stichpunkten zusammen. Die Zusammenfassung soll dem Nutzer einen schnellen Überblick geben: Worum geht es? Was sind die wichtigsten Informationen oder nächsten Schritte?\n\n${emailContent}`;
        const res = await callAzure(p);
        emailSummaryDiv.innerText = res || "Keine Zusammenfassung verfügbar.";
      }

      // Initialisierung beim Laden
      document.addEventListener('DOMContentLoaded', initTheme);

      Office.onReady((info)=>{
        if(!Office.context.mailbox?.item){
          logError("Kein E-Mail-Kontext verfügbar.");
          return;
        }
        
        const item = Office.context.mailbox.item;
        
        // Load subject/sender
        if(info.platform==="OfficeOnline"){
          emailSubject = item.subject || "Kein Betreff";
          document.getElementById("emailSubject").innerText = emailSubject;
          emailSender = item.from?.displayName||item.from?.emailAddress||"Unbekannter Absender";
          document.getElementById("emailSender").innerText = "Von: "+emailSender;
        } else {
          item.subject.getAsync((r)=>{ 
            if(r.status===Office.AsyncResultStatus.Succeeded){
              emailSubject = r.value || "Kein Betreff";
              document.getElementById("emailSubject").innerText = emailSubject;
            }
          });
          item.from.getAsync((r)=>{ 
            if(r.status===Office.AsyncResultStatus.Succeeded){
              emailSender = r.value.displayName||r.value.emailAddress||"Unbekannter Absender";
              document.getElementById("emailSender").innerText = "Von: "+emailSender;
            }
          });
        }
        
        // Load email content
        item.body.getAsync("text",(r)=>{
          if(r.status===Office.AsyncResultStatus.Succeeded){
            emailContent = r.value || "Inhalt verfügbar";
            summarizeEmail().then(()=>{
              isContentLoaded=true;
              actionButton.disabled=false;
              // initial ready icon
              lottieHeaderReady.style.display="block";
              actionButton.textContent = action==="zusammenfassen"?"Zusammenfassen":
                                        action==="antworten"?"Antwort formulieren":
                                        action==="übersetzen"?"Übersetzen":"Freier Modus";
            });
          } else {
            logError("Fehler beim Laden: "+r.error.message);
          }
        });
      }).catch(e=>logError("Office.js Fehler: "+e.message));
    </script>
  </body>
</html>
