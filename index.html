<!DOCTYPE html>
<html>
  <head>
    <title>MailAider AI 3.0</title>
    <meta charset="UTF-8" />
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script
      src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs"
      type="module"
    ></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        line-height: 1.5;
        font-weight: 400;
        color: #e0e0e0;
        background: linear-gradient(135deg, #2c2f33 0%, #1a1d23 100%);
        padding: 0.25rem;
        max-width: 350px;
        margin: 0 auto;
        transition: background 0.3s;
      }
      .light-mode {
        background: #fff;
        color: #333;
      }
      .light-mode .container {
        background: rgba(255, 255, 255, 0.8);
        border-color: #ccc;
      }
      .light-mode .email-viewer,
      .light-mode .output-container,
      .light-mode .input-container {
        background: rgba(255, 255, 255, 0.1);
        border-color: #ccc;
      }
      .light-mode .email-body,
      .light-mode .summary,
      .light-mode #output {
        background: rgba(255, 255, 255, 0.05);
        border-color: #ccc;
      }
      .light-mode .input-container input,
      .light-mode select {
        background: rgba(255, 255, 255, 0.1);
        border-color: #ccc;
        color: #333;
      }
      .light-mode .send-button {
        background: #1e90ff;
      }
      .light-mode .copy-button {
        background: rgba(255, 255, 255, 0.1);
        color: #1e90ff;
      }
      .container {
        background: rgba(44, 47, 51, 0.9);
        border: 1px solid #4a4e57;
        border-radius: 8px;
        padding: 0.5rem;
      }
      .header {
        position: relative;
        padding: 0.5rem;
        border-bottom: 1px solid #4a4e57;
        text-align: center;
      }
      .dark-mode-toggle {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        font-size: 1.2rem;
        cursor: pointer;
        color: #87cefa;
      }
      .light-mode .dark-mode-toggle {
        color: #1e90ff;
      }
      
      /* Privacy Notice Styles */
      .privacy-notice {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 10px 15px;
        border-radius: 16px;
        font-size: 14px;
        margin: 10px auto;
        width: fit-content;
        background: rgba(255, 255, 255, 0.1);
        color: #e0e0e0;
      }
      
      .light-mode .privacy-notice {
        background: rgba(0, 0, 0, 0.05);
        color: #333;
      }
      
      .privacy-lottie {
        width: 24px !important;
        height: 24px !important;
      }

      /* Rest der CSS-Stile... */
      .action-buttons {
        display: flex;
        justify-content: space-between;
        margin: 0.5rem 0;
        padding: 0.5rem;
        background: rgba(34, 37, 41, 0.7);
        border: 1px solid #4a4e57;
        border-radius: 8px;
        box-shadow: 0 3px 15px rgba(0, 240, 255, 0.1);
      }
      .light-mode .action-buttons {
        background: rgba(255, 255, 255, 0.1);
        border-color: #ccc;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
      }
      .action-button {
        background: none;
        border: none;
        padding: 0.5rem;
        font-size: 1.5rem;
        color: #87cefa;
        cursor: pointer;
        transition: color 0.2s ease;
        flex: 1;
        text-align: center;
        border-right: 1px solid #4a4e57;
        position: relative;
      }
      .light-mode .action-button {
        color: #1e90ff;
      }
      .action-button:hover {
        color: #00ff7f;
      }
      .action-button:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        top: -2.5rem;
        left: 50%;
        transform: translateX(-50%);
        background: #1e90ff;
        color: #fff;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        white-space: nowrap;
      }
      .action-button:last-child {
        border-right: none;
      }
      .email-viewer,
      .output-container,
      .input-container {
        padding: 0.5rem;
        margin: 0.5rem 0;
        background: rgba(34, 37, 41, 0.7);
        border-radius: 8px;
        border: 1px solid #4a4e57;
        box-shadow: 0 3px 15px rgba(0, 240, 255, 0.1);
      }
      .light-mode .email-viewer,
      .light-mode .output-container,
      .light-mode .input-container {
        background: rgba(255, 255, 255, 0.1);
        border-color: #ccc;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
      }
      .email-header {
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #4a4e57;
      }
      .light-mode .email-header {
        border-bottom-color: #ccc;
      }
      .email-header h2 {
        font-weight: 700;
        color: #e0e0e0;
        font-size: 1rem;
      }
      .light-mode .email-header h2 {
        color: #333;
      }
      .email-header p {
        color: #a0a0a0;
        font-size: 0.85rem;
        margin: 0;
      }
      .light-mode .email-header p {
        color: #666;
      }
      .email-body {
        margin-top: 0.5rem;
        line-height: 1.6;
        color: #e0e0e0;
        font-size: 0.85rem;
        white-space: pre-wrap;
        background: rgba(40, 44, 52, 0.5);
        padding: 0.5rem;
        border-radius: 6px;
        border: 1px solid #4a4e57;
        height: 200px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #87cefa #000;
        display: none;
      }
      .light-mode .email-body {
        color: #333;
        background: rgba(255, 255, 255, 0.05);
        border-color: #ccc;
        scrollbar-color: #1e90ff #fff;
      }
      .email-body.active {
        display: block;
      }
      .email-body::-webkit-scrollbar {
        width: 8px;
      }
      .email-body::-webkit-scrollbar-track {
        background: #2c2f33;
      }
      .light-mode .email-body::-webkit-scrollbar-track {
        background: #fff;
      }
      .email-body::-webkit-scrollbar-thumb {
        background-color: #87cefa;
        border-radius: 4px;
        border: 2px solid #2c2f33;
      }
      .light-mode .email-body::-webkit-scrollbar-thumb {
        border-color: #fff;
        background-color: #1e90ff;
      }
      .summary {
        margin-top: 0.5rem;
        line-height: 1.6;
        color: #e0e0e0;
        font-size: 0.85rem;
        white-space: pre-wrap;
        background: rgba(40, 44, 52, 0.5);
        padding: 0.5rem;
        border-radius: 6px;
        border: 1px solid #4a4e57;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #87cefa #000;
      }
      .light-mode .summary {
        color: #333;
        background: rgba(255, 255, 255, 0.05);
        border-color: #ccc;
        scrollbar-color: #1e90ff #fff;
      }
      .summary::-webkit-scrollbar {
        width: 8px;
      }
      .summary::-webkit-scrollbar-track {
        background: #2c2f33;
      }
      .light-mode .summary::-webkit-scrollbar-track {
        background: #fff;
      }
      .summary::-webkit-scrollbar-thumb {
        background-color: #87cefa;
        border-radius: 4px;
        border: 2px solid #2c2f33;
      }
      .light-mode .summary::-webkit-scrollbar-thumb {
        border-color: #fff;
        background-color: #1e90ff;
      }
      .show-full-email {
        background: #1e90ff;
        border: none;
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
        color: #fff;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 0.25rem;
        width: auto;
        transition: background 0.2s ease;
      }
      .show-full-email:hover {
        background: #00ff7f;
      }
      .output-container {
        height: 250px;
        overflow-y: auto;
        position: relative;
        padding: 0.5rem;
        scrollbar-width: thin;
        scrollbar-color: #87cefa #000;
      }
      .light-mode .output-container {
        scrollbar-color: #1e90ff #fff;
      }
      .output-container::-webkit-scrollbar {
        width: 8px;
      }
      .output-container::-webkit-scrollbar-track {
        background: #2c2f33;
      }
      .light-mode .output-container::-webkit-scrollbar-track {
        background: #fff;
      }
      .output-container::-webkit-scrollbar-thumb {
        background-color: #87cefa;
        border-radius: 4px;
        border: 2px solid #2c2f33;
      }
      .light-mode .output-container::-webkit-scrollbar-thumb {
        border-color: #fff;
        background-color: #1e90ff;
      }

      #lottieLoader {
        display: none;
        margin: 1rem auto;
      }

      #output {
        user-select: text;
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        line-height: 1.6;
        color: #e0e0e0;
        font-size: 0.85rem;
        white-space: pre-wrap;
      }
      .light-mode #output {
        color: #333;
      }
      .copy-button {
        position: sticky;
        bottom: 0.5rem;
        right: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid #4a4e57;
        border-radius: 4px;
        padding: 0.25rem;
        font-size: 0.9rem;
        color: #87cefa;
        cursor: pointer;
        transition: background 0.3s ease, color 0.3s ease;
        z-index: 10;
        margin-left: auto;
        margin-right: 0;
        display: block;
      }
      .light-mode .copy-button {
        border-color: #ccc;
        color: #1e90ff;
      }
      .copy-button:hover {
        background: rgba(255, 255, 255, 0.2);
        color: #00ff7f;
      }
      .input-container input {
        width: 100%;
        padding: 0.5rem;
        background: rgba(40, 44, 52, 0.7);
        border: 1px solid #4a4e57;
        border-radius: 8px;
        color: #e0e0e0;
        font-size: 0.9rem;
        transition: border-color 0.3s ease;
      }
      .light-mode .input-container input {
        background: rgba(255, 255, 255, 0.1);
        border-color: #ccc;
        color: #333;
      }
      .input-container input:focus {
        border-color: #87cefa;
        outline: none;
      }
      .light-mode .input-container input:focus {
        border-color: #1e90ff;
      }
      .send-button {
        background: #1e90ff;
        border-radius: 0;
        padding: 0.5rem 1rem;
        font-size: 0.95rem;
        color: #fff;
        border: none;
        cursor: pointer;
        margin-top: 0.5rem;
        width: 100%;
        transition: background 0.2s ease;
      }
      .send-button:disabled {
        cursor: not-allowed;
      }
      .send-button:hover:not(:disabled) {
        background: #00ff7f;
      }
      .settings-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #2c2f33 0%, #1a1d23 100%);
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        padding: 1.5rem;
        min-width: 300px;
        max-width: 90%;
        z-index: 2000;
        display: none;
        font-family: "Inter", sans-serif;
      }
      .light-mode .settings-modal {
        background: #fff;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .settings-modal.active {
        display: block;
      }
      .form-group {
        margin-bottom: 0.75rem;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.25rem;
        font-weight: 600;
        color: #e0e0e0;
        font-size: 0.9rem;
      }
      .light-mode .form-group label {
        color: #333;
      }
      .form-group select {
        width: 100%;
        padding: 0.5rem;
        border: 2px solid #4a4e57;
        border-radius: 6px;
        font-size: 0.9rem;
        background: #2d2d2d;
        color: #e0e0e0;
        transition: border-color 0.3s ease;
      }
      .light-mode .form-group select {
        background: #fff;
        border-color: #ccc;
        color: #333;
      }
      .form-group select:focus {
        border-color: #87cefa;
        outline: none;
      }
      .light-mode .form-group select:focus {
        border-color: #1e90ff;
      }
      .error {
        color: #ff6b6b;
        font-size: 0.85rem;
        margin: 0.5rem 0;
        padding: 0.25rem;
        background: rgba(255, 107, 107, 0.2);
        border-radius: 4px;
        display: none;
      }
      .light-mode .error {
        background: rgba(255, 107, 107, 0.1);
      }
      .error.active {
        display: block;
      }

      .prompt-input {
        width: 100%;
        box-sizing: border-box;
        resize: vertical;
        height: 150px;
        min-height: 100px;
        padding: 5px;
        font-family: "Inter", sans-serif;
        color: #e0e0e0 !important;
        background-color: #2d2d2d;
        border-radius: 5px;
        border: 1px solid #4a4e57;
      }
      .light-mode .prompt-input {
        color: black !important;
        background-color: white;
        border-color: rgba(104, 104, 104, 0.645);
      }
      .prompt-input::placeholder {
        color: rgba(224, 224, 224, 0.7);
      }
      .light-mode .prompt-input::placeholder {
        color: rgba(0, 0, 0, 0.678);
      }
      .prompt-input:focus {
        outline: 1px solid #87cefa;
      }
      .light-mode .prompt-input:focus {
        outline: 1px solid rgba(0, 0, 0, 0.702);
      }
    </style>
  </head>
  <script>
// Funktion zum Anzeigen des Popups
function showPopup(message) {
  const popup = document.getElementById('customPopup');
  document.getElementById('popupContent').innerHTML = message;
  popup.style.display = 'flex';
}

// Funktion zum Verstecken des Popups
function hidePopup() {
  document.getElementById('customPopup').style.display = 'none';
}
</script>
  <body>
    <!-- Popup Container (am Ende des body tags) -->
<div id="customPopup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:8px; max-width:80%; max-height:80%; overflow:auto;">
    <div id="popupContent"></div>
    <button onclick="hidePopup()" style="margin-top:15px; padding:5px 10px; background:#1e90ff; color:white; border:none; border-radius:4px; cursor:pointer;">
      Schlie√üen
    </button>
  </div>
</div>
    <div class="container">
      <div class="header">
        <span class="dark-mode-toggle" onclick="toggleDarkMode()">‚òÄÔ∏è</span>
      </div>
      
      <!-- Unternehmensdatenschutz Hinweis -->
      <div class="privacy-notice">
        <dotlottie-player
          class="privacy-lottie"
          src="https://lottie.host/315e81ec-fb44-44fe-a9c5-bf08ce9bc46b/dnLhElwMXh.lottie"
          background="transparent"
          speed="1"
          loop
          autoplay
        ></dotlottie-player>
        <span>DSGVO SICHER</span>
      </div>
      
      <div class="error" id="error"></div>
      <div class="email-viewer">
        <div class="email-header">
          <h2 id="emailSubject">Lade Betreff...</h2>
          <p id="emailSender">Lade Absender...</p>
        </div>
        <div class="summary" id="emailSummary" style="display: none">
          Lade Zusammenfassung...
        </div>
        <button
          class="send-button"
          id="toggleSummaryButton"
          onclick="toggleSummary()"
        >
          Zusammenfassung anzeigen
        </button>
      </div>
      <div class="output-container">
        <dotlottie-player
          id="lottieLoader"
          src="https://lottie.host/c50dbde0-250a-43a1-8493-de801fb3caf5/zs2kPt4Uv9.lottie"
          background="transparent"
          speed="1"
          style="width: 100px; height: 100px; margin: 0 auto; display: none"
          loop
          autoplay
        ></dotlottie-player>
        <div id="output">Warte auf Ausgabe...</div>
        <button class="copy-button" onclick="copyOutputContent()">üìã</button>
      </div>
      <div class="input-container">
        <textarea
          class="prompt-input"
          id="promptInput"
          placeholder="Was soll verarbeitet werden? (optional)"
          rows="4"
        ></textarea>

        <button
          class="send-button"
          id="actionButton"
          onclick="openSettings()"
          disabled
        >
          Lade...
        </button>
      </div>
      <div class="action-buttons">
        <button
          class="action-button"
          onclick="setAction('zusammenfassen')"
          data-tooltip="Zusammenfassen"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="size-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 0 1 .865-.501 48.172 48.172 0 0 0 3.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0 0 12 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018Z"
            />
          </svg>
        </button>
        <button
          class="action-button"
          onclick="setAction('antworten')"
          data-tooltip="Antworten"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="size-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"
            />
          </svg>
        </button>
        <button
          class="action-button"
          onclick="setAction('√ºbersetzen')"
          data-tooltip="√úbersetzen"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="size-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="m10.5 21 5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 0 1 6-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C11.176 10.658 7.69 15.08 3 17.502m9.334-12.138c.896.061 1.785.147 2.666.257m-4.589 8.495a18.023 18.023 0 0 1-3.827-5.802"
            />
          </svg>
        </button>
        <button
          class="action-button"
          onclick="setAction('freierModus')"
          data-tooltip="Freier Modus"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="size-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M13.5 10.5V6.75a4.5 4.5 0 1 1 9 0v3.75M3.75 21.75h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H3.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z"
            />
          </svg>
        </button>
      </div>
      <div class="settings-modal" id="settingsModal">
        <div class="form-group" id="modeGroup">
          <label>Verarbeitung:</label>
          <select id="modeSelect" onchange="updateSettings()">
            <option value="azure">‚ö° Schnell (Azure)</option>
            <option value="ollama">üîí Datenschutz (Ollama)</option>
          </select>
        </div>
        <div class="form-group" id="toneGroup" style="display: none">
          <label>Tonfall:</label>
          <select id="toneSelect">
            <option value="formell">Formell</option>
            <option value="informell">Informell</option>
            <option value="h√∂flich">H√∂flich</option>
            <option value="direkt">Direkt & pr√§gnant</option>
          </select>
        </div>
        <div class="form-group" id="greetingGroup" style="display: none">
          <label>Anrede:</label>
          <select id="greetingSelect">
            <option value="informell">Du (informell)</option>
            <option value="formell">Sie (formell)</option>
          </select>
        </div>
        <div class="form-group" id="lengthGroup" style="display: none">
          <label>L√§nge:</label>
          <select id="lengthSelect">
            <option value="kurz">Kurz</option>
            <option value="mittel">Mittel</option>
            <option value="lang">Lang</option>
          </select>
        </div>
        <div class="form-group" id="languageGroup" style="display: none">
          <label>Zielsprache:</label>
          <select id="languageSelect">
            <option value="deutsch">Deutsch</option>
            <option value="englisch">Englisch</option>
            <option value="franz√∂sisch">Franz√∂sisch</option>
            <option value="italienisch">Italienisch</option>
          </select>
        </div>
        <button
          class="send-button"
          id="submitModal"
          onclick="handleSubmitFromModal()"
        >
          Ausf√ºhren
        </button>
        <button class="send-button" onclick="closeSettings()">Schlie√üen</button>
      </div>
    </div>
    <script>
      const errorDiv = document.getElementById("error");
      const actionButton = document.getElementById("actionButton");
      const settingsModal = document.getElementById("settingsModal");
      const emailContentDiv = document.getElementById("emailContent");
      const emailSummaryDiv = document.getElementById("emailSummary");
      const lottieLoader = document.getElementById("lottieLoader");

      let emailContent = "";
      let emailSubject = "";
      let emailSender = "";
      let mode = "azure";
      let action = "antworten";
      let tone = "formell";
      let language = "deutsch";
      let greeting = "informell";
      let length = "kurz";
      let isContentLoaded = false;

      // Standardm√§√üig Dunkelmodus aktivieren
      document.body.classList.add("dark-mode");
      document.querySelector(".dark-mode-toggle").textContent = "‚òÄÔ∏è";

      // Initialisiere Privacy Lottie basierend auf aktuellem Modus
      function initPrivacyLottie() {
        const isDarkMode = document.body.classList.contains("dark-mode");
        const privacyLottie = document.querySelector(".privacy-lottie");
        if (privacyLottie) {
          privacyLottie.src = isDarkMode 
            ? "https://lottie.host/315e81ec-fb44-44fe-a9c5-bf08ce9bc46b/dnLhElwMXh.lottie"
            : "https://lottie.host/ca615a42-7026-46ed-8ad3-5d1d3be3bee4/jRk8P0eZ6D.lottie";
        }
      }

      function logError(message) {
        console.error(message);
        errorDiv.innerText = message;
        errorDiv.classList.add("active");
      }

      function toggleDarkMode() {
        const isDarkMode = document.body.classList.toggle("dark-mode");
        document.body.classList.toggle("light-mode", !isDarkMode);
        document.querySelector(".dark-mode-toggle").textContent = isDarkMode ? "‚òÄÔ∏è" : "üåô";
        
        // Update Lottie animation based on theme
        const privacyLottie = document.querySelector(".privacy-lottie");
        if (privacyLottie) {
          privacyLottie.src = isDarkMode 
            ? "https://lottie.host/315e81ec-fb44-44fe-a9c5-bf08ce9bc46b/dnLhElwMXh.lottie"
            : "https://lottie.host/ca615a42-7026-46ed-8ad3-5d1d3be3bee4/jRk8P0eZ6D.lottie";
        }
      }

      function openSettings() {
        if (isContentLoaded) {
          settingsModal.classList.add("active");
          document.getElementById("modeSelect").value = mode;
          updateSettings();
        }
      }

      function closeSettings() {
        settingsModal.classList.remove("active");
      }

      function mapLanguage(lang) {
        const languageMap = {
          deutsch: "German",
          englisch: "English",
          franz√∂sisch: "French",
          italienisch: "Italian",
        };
        return languageMap[lang] || lang;
      }

      function setAction(newAction) {
        action = newAction;
        actionButton.textContent =
          action === "zusammenfassen"
            ? "Zusammenfassen"
            : action === "antworten"
            ? "Antworten formulieren"
            : action === "√ºbersetzen"
            ? "√úbersetzen"
            : "Freier Modus";
        if (isContentLoaded) actionButton.disabled = false;
        updateSettings();
      }

      function updateSettings() {
        mode = document.getElementById("modeSelect").value;
        const toneGroup = document.getElementById("toneGroup");
        const greetingGroup = document.getElementById("greetingGroup");
        const lengthGroup = document.getElementById("lengthGroup");
        const languageGroup = document.getElementById("languageGroup");

        toneGroup.style.display = action === "antworten" ? "block" : "none";
        greetingGroup.style.display = action === "antworten" ? "block" : "none";
        lengthGroup.style.display = action === "antworten" ? "block" : "none";
        languageGroup.style.display =
          action === "√ºbersetzen" ? "block" : "none";

        if (action === "antworten") {
          tone = document.getElementById("toneSelect").value;
          greeting = document.getElementById("greetingSelect").value;
          length = document.getElementById("lengthSelect").value;
        } else if (action === "√ºbersetzen") {
          language = mapLanguage(
            document.getElementById("languageSelect").value
          );
        } else if (action === "freierModus") {
          toneGroup.style.display = "none";
          greetingGroup.style.display = "none";
          lengthGroup.style.display = "none";
          languageGroup.style.display = "none";
        }
      }

      function toggleSummary() {
        const summary = document.getElementById("emailSummary");
        const btn = document.getElementById("toggleSummaryButton");
        if (summary.style.display === "none") {
          summary.style.display = "block";
          btn.innerText = "Zusammenfassung verbergen";
        } else {
          summary.style.display = "none";
          btn.innerText = "Zusammenfassung anzeigen";
        }
      }

      function copyOutputContent() {
        const outputElement = document.getElementById("output");
        const text = outputElement.innerText;
        const textarea = document.createElement("textarea");
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand("copy");
        } catch (err) {
        } finally {
          document.body.removeChild(textarea);
        }
      }

      async function callAzure(prompt) {
        try {
          lottieLoader.style.display = "block";
          
          const response = await fetch(
            "https://openaiaddinapi.openai.azure.com/openai/deployments/gpt-4o_MailAiderAi_OutlookAddIn/chat/completions?api-version=2025-01-01-preview",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "api-key":
                  "9psvVslPXfp4xbJ9SzRXpfx9E9lP8TLiFcC3IZgf43RLNQA9RiV4JQQJ99BFACI8hq2XJ3w3AAABACOGHQcr",
              },
              body: JSON.stringify({
                messages: [
                  {
                    role: "system",
                    content:
                      "Du bist ein E-Mail-Assistent. Verwende immer die Schweizer Rechtschreibung. Nutze den bereitgestellten E-Mail-Inhalt als Grundlage, sofern kein separater Benutzertext gegeben ist.",
                  },
                  { role: "user", content: prompt },
                ],
                temperature: 0.6,
              }),
            }
          );
          
          const data = await response.json();
          return (
            data.choices?.[0]?.message?.content || "‚ùå Keine Antwort erhalten."
          );
        } catch (error) {
          return "‚ùå Fehler bei Azure: " + error.message;
        } finally {
          lottieLoader.style.display = "none";
        }
      }

      async function callLokal(prompt) {
        try {
          lottieLoader.style.display = "block";
          
          const response = await fetch("http://localhost:11434/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              model: "nous-hermes2",
              messages: [
                {
                  role: "system",
                  content:
                    "Rolle: Du bist ein professioneller E-Mail-Assistent. Nutze konsequent Schweizer Rechtschreibung. Bei Antworten beachte Tonalit√§t, Anredeform und Textl√§nge gem√§ss Benutzervorgabe. Der Benutzertext hat Vorrang vor dem E-Mail-Inhalt.",
                },
                { role: "user", content: prompt },
              ],
              stream: false,
            }),
          });
          
          const data = await response.json();
          return data.message?.content || "‚ùå Keine Antwort erhalten.";
        } catch (error) {
          return "‚ùå Fehler bei Lokal: " + error.message;
        } finally {
          lottieLoader.style.display = "none";
        }
      }

      async function handleSubmitFromModal() {
        const promptInput = document.getElementById("promptInput").value;
        const outputDiv = document.getElementById("output");
        const outputContainer = outputDiv.parentElement;
        outputContainer.classList.add("processing");

        outputDiv.innerText = "";
        lottieLoader.style.display = "block";

        if (!emailContent && !promptInput) {
          outputDiv.innerText =
            "‚ùå Kein E-Mail-Inhalt oder Benutzertext verf√ºgbar.";
          outputContainer.classList.remove("processing");
          closeSettings();
          return;
        }

        const emailText = emailContent ? `Kontext: ${emailContent}\n` : "";
        let fullPrompt = promptInput || "";
        if (action === "zusammenfassen") {
          fullPrompt = `Fasse den Inhalt der folgenden E-Mail in Stichpunkten zusammen. Nutze Anstatt Striche - Punkte ‚óè pr√§gnanten Stichpunkten zusammen. Die Zusammenfassung darf etwas ausf√ºhrlicher sein, soll aber dennoch klar und strukturiert bleiben. Ziel ist es, dem Nutzer einen schnellen, aber umfassenden √úberblick zu geben: Worum geht es? Welche Themen oder Anliegen werden genannt? Was sind wichtige Informationen oder n√§chste Schritte? \n\n${emailText}${promptInput}`;
        } else if (action === "antworten") {
          fullPrompt = `Formuliere eine Antwort auf die folgende E-Mail im ${tone} Ton mit ${greeting} Anrede (${length}) Sprachstil: Verwende durchg√§ngig die Schweizer Rechtschreibung. Inhaltliche Grundlage: Nutze den bereitgestellten E-Mail-Inhalt als Ausgangspunkt, ausser es wird ein separater Benutzertext angegeben, dann hat dieser Vorrang. Begr√ºssung: Beginne die Antwort mit: ‚ÄûHallo [Name des Absenders der urspr√ºnglichen E-Mail]`. Wenn der Name des Absenders nicht erkannt werden kann, schreibe nur: ‚ÄûHallo,". Grussformel: Lasse die Grussformel beim Beantworten von E-Mails aus. Tonalit√§t: Parameter wie formell/informell sowie Sie/Du werden vom Benutzer angegeben. Richte Formulierung, Ansprache und Stil konsequent nach diesen Angaben aus. Formatierung: Lasse Betreff immer aus und bringe es nicht in die Antwort ein. Verzichte am Ende auf eine Grussformel.:\n${emailText}${promptInput}`;
        } else if (action === "√ºbersetzen") {
          fullPrompt = `√úbersetze den folgenden E-Mail-Inhalt vollst√§ndig und ausschlie√ülich ins ${mapLanguage(
            language
          )}:\n${emailText}${promptInput}`;
        } else if (action === "freierModus") {
          fullPrompt = `${emailText}${promptInput}`;
        }

        closeSettings();
        const apiCall = mode === "azure" ? callAzure : callLokal;
        const response = await apiCall(fullPrompt);
        outputDiv.innerText = response;
        outputContainer.classList.remove("processing");
      }

      async function summarizeEmail() {
        if (emailContent) {
          const fullPrompt = `Fasse den Inhalt der folgenden E-Mail in maximal 4 Stichpunkten und nicht in ganzen S√§tzen. Nutze Anstatt Striche - Punkte ‚óè pr√§gnanten Stichpunkten zusammen. Die Zusammenfassung soll dem Nutzer einen schnellen √úberblick geben: Worum geht es? Was sind die wichtigsten Informationen oder n√§chsten Schritte?\n\n${emailContent}`;
          const response = await callAzure(fullPrompt);
          emailSummaryDiv.innerText =
            response || "Keine Zusammenfassung verf√ºgbar.";
        }
      }

      Office.onReady((info) => {
        console.log(
          "Office.js funktioniert host:",
          info.host,
          "platform:",
          info.platform
        );
        if (!Office.context.mailbox || !Office.context.mailbox.item) {
          logError(
            "Kein E-Mail-Kontext verf√ºgbar. Bitte eine E-Mail ausw√§hlen."
          );
          return;
        }

        initPrivacyLottie();

        const item = Office.context.mailbox.item;
        const isOutlookWeb = info.platform === "OfficeOnline";

        if (isOutlookWeb) {
          emailSubject = item.subject || "Kein Betreff";
          document.getElementById("emailSubject").innerText = emailSubject;
          emailSender =
            (item.from && (item.from.displayName || item.from.emailAddress)) ||
            "Unbekannter Absender";
          document.getElementById("emailSender").innerText =
            "Von: " + emailSender;
        } else {
          item.subject.getAsync((result) => {
            if (result.status === Office.AsyncResultStatus.Succeeded) {
              emailSubject = result.value || "Kein Betreff";
              document.getElementById("emailSubject").innerText = emailSubject;
            } else {
              logError(
                "Fehler beim Laden des Betreffs: " + result.error.message
              );
            }
          });
          item.from.getAsync((result) => {
            if (result.status === Office.AsyncResultStatus.Succeeded) {
              emailSender =
                result.value.displayName ||
                result.value.emailAddress ||
                "Unbekannter Absender";
              document.getElementById("emailSender").innerText =
                "Von: " + emailSender;
            } else {
              logError(
                "Fehler beim Laden des Absenders: " + result.error.message
              );
            }
          });
        }

        item.body.getAsync("text", (result) => {
          if (result.status === Office.AsyncResultStatus.Succeeded) {
            emailContent = result.value || "Inhalt verf√ºgbar";
            summarizeEmail().then(() => {
              isContentLoaded = true;
              actionButton.disabled = false;
              actionButton.textContent =
                action === "zusammenfassen"
                  ? "Zusammenfassen"
                  : action === "antworten"
                  ? "Antwort formulieren"
                  : action === "√ºbersetzen"
                  ? "√úbersetzen"
                  : "Freier Modus";
            });
          } else {
            logError("Fehler: " + result.error.message);
          }
        });
      }).catch((error) => {
        logError("Office.js Fehler: " + error.message);
      });
    </script>
  </body>
</html>
