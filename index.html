<!DOCTYPE html>
<html>
  <head>
    <title>MailAider</title>
    <meta charset="UTF-8" />
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script
      src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs"
      type="module"
    ></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        line-height: 1.5;
        font-weight: 400;
        color: #333;
        background: #fff;
        padding: 0.25rem;
        max-width: 350px;
        margin: 0 auto;
        transition: background 0.3s;
      }
      .dark-mode {
        background: linear-gradient(135deg, #2c2f33 0%, #1a1d23 100%);
        color: #e0e0e0;
      }
      .dark-mode .container {
        background: rgba(44, 47, 51, 0.9);
        border-color: #4a4e57;
      }
      
<style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        line-height: 1.5;
        font-weight: 400;
        color: #333;
        background: #fff;
        padding: 0.25rem;
        max-width: 350px;
        margin: 0 auto;
        transition: background 0.3s;
      }
      .dark-mode {
        background: linear-gradient(135deg, #2c2f33 0%, #1a1d23 100%);
        color: #e0e0e0;
      }
      .dark-mode .container {
        background: rgba(44, 47, 51, 0.9);
        border-color: #4a4e57;
      }
      .dark-mode .email-viewer,
      .dark-mode .output-container,
      .dark-mode .input-container {
        background: rgba(34, 37, 41, 0.7);
        border-color: #4a4e57;
      }
      .dark-mode .email-body,
      .dark-mode .summary,
      .dark-mode #output {
        background: rgba(40, 44, 52, 0.5);
        border-color: #4a4e57;
      }
      .dark-mode .input-container input,
      .dark-mode select {
        background: rgba(40, 44, 52, 0.7);
        border-color: #4a4e57;
        color: #e0e0e0;
      }
      .dark-mode .send-button {
        background: #1e90ff;
      }
      .dark-mode .send-button:hover:not(:disabled) {
        background: #87cefa;
      }
      .dark-mode .copy-button {
        background: rgba(255, 255, 255, 0.1);
        color: #1e90ff;
      }
      .dark-mode .copy-button:hover {
        background: rgba(255, 255, 255, 0.2);
        color: #87cefa;
      }
      .container {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 0.5rem;
      }
      .header {
        position: relative;
        padding: 0.5rem;
        border-bottom: 1px solid #ccc;
        text-align: center;
        display: flex;
        align-items: center;
      }
      .logo {
        width: 30px;
        height: auto;
        margin-right: 0.5rem;
      }
      .main-heading {
        font-family: "Franklin Gothic Medium", "Arial Narrow", Arial, sans-serif;
        font-size: 1.4rem;
        font-weight: 800;
        letter-spacing: -0.02em;
        color: #1e90ff;
      }
      .dark-mode .main-heading {
        color: #87cefa;
      }
      .dark-mode-toggle {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        font-size: 1.2rem;
        cursor: pointer;
        color: #1e90ff;
      }
      .dark-mode .dark-mode-toggle {
        color: #87cefa;
      }
      .action-buttons {
        display: flex;
        justify-content: space-between;
        margin: 0.5rem 0;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
      }
      .dark-mode .action-buttons {
        background: rgba(34, 37, 41, 0.7);
        border-color: #4a4e57;
        box-shadow: 0 3px 15px rgba(0, 240, 255, 0.1);
      }
      .action-button {
        background: none;
        border: none;
        padding: 0.5rem;
        font-size: 1.5rem;
        color: #1e90ff;
        cursor: pointer;
        transition: color 0.2s ease;
        flex: 1;
        text-align: center;
        border-right: 1px solid #ccc;
        position: relative;
      }
      .dark-mode .action-button {
        color: #87cefa;
      }
      .action-button:hover {
        color: #00ff7f;
      }
      .action-button:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        top: -2.5rem;
        left: 50%;
        transform: translateX(-50%);
        background: #1e90ff;
        color: #fff;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        white-space: nowrap;
      }
      .dark-mode .action-button:hover {
        color: #00ff7f;
      }
      .action-button:last-child {
        border-right: none;
      }
      .email-viewer,
      .output-container,
      .input-container {
        padding: 0.5rem;
        margin: 0.5rem 0;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        border: 1px solid #ccc;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
      }
      .dark-mode .email-viewer,
      .dark-mode .output-container,
      .dark-mode .input-container {
        background: rgba(34, 37, 41, 0.7);
        border-color: #4a4e57;
        box-shadow: 0 3px 15px rgba(0, 240, 255, 0.1);
      }
      .email-header {
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #ccc;
      }
      .dark-mode .email-header {
        border-bottom-color: #4a4e57;
      }
      .email-header h2 {
        font-weight: 700;
        color: #333;
        font-size: 1rem;
      }
      .dark-mode .email-header h2 {
        color: #e0e0e0;
      }
      .email-header p {
        color: #666;
        font-size: 0.85rem;
        margin: 0;
      }
      .dark-mode .email-header p {
        color: #a0a0a0;
      }
      .email-body {
        margin-top: 0.5rem;
        line-height: 1.6;
        color: #333;
        font-size: 0.85rem;
        white-space: pre-wrap;
        background: rgba(255, 255, 255, 0.05);
        padding: 0.5rem;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        height: 200px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #1e90ff #fff;
        display: none;
      }
      .dark-mode .email-body {
        color: #e0e0e0;
        background: rgba(40, 44, 52, 0.5);
        border-color: #4a4e57;
        scrollbar-color: #87cefa #000;
      }
      .email-body.active {
        display: block;
      }
      .email-body::-webkit-scrollbar {
        width: 8px;
      }
      .email-body::-webkit-scrollbar-track {
        background: #fff;
      }
      .dark-mode .email-body::-webkit-scrollbar-track {
        background: #2c2f33;
      }
      .email-body::-webkit-scrollbar-thumb {
        background-color: #1e90ff;
        border-radius: 4px;
        border: 2px solid #fff;
      }
      .dark-mode .email-body::-webkit-scrollbar-thumb {
        border-color: #2c2f33;
        background-color: #87cefa;
      }
      .summary {
        margin-top: 0.5rem;
        line-height: 1.6;
        color: #333;
        font-size: 0.85rem;
        white-space: pre-wrap;
        background: rgba(255, 255, 255, 0.05);
        padding: 0.5rem;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #1e90ff #fff;
      }
      .dark-mode .summary {
        color: #e0e0e0;
        background: rgba(40, 44, 52, 0.5);
        border-color: #4a4e57;
        scrollbar-color: #87cefa #000;
      }
      .summary::-webkit-scrollbar {
        width: 8px;
      }
      .summary::-webkit-scrollbar-track {
        background: #fff;
      }
      .dark-mode .summary::-webkit-scrollbar-track {
        background: #2c2f33;
      }
      .summary::-webkit-scrollbar-thumb {
        background-color: #1e90ff;
        border-radius: 4px;
        border: 2px solid #fff;
      }
      .dark-mode .summary::-webkit-scrollbar-thumb {
        border-color: #2c2f33;
        background-color: #87cefa;
      }
      .show-full-email {
        background: #1e90ff;
        border: none;
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
        color: #fff;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 0.25rem;
        width: auto;
        transition: background 0.2s ease;
      }
      .dark-mode .show-full-email {
        background: #1e90ff;
      }
      .show-full-email:hover {
        background: #00ff7f;
      }
      .dark-mode .show-full-email:hover {
        background: #00ff7f;
      }
      .output-container {
        height: 250px;
        overflow-y: auto;
        position: relative;
        padding: 0.5rem;
        scrollbar-width: thin;
        scrollbar-color: #1e90ff #fff;
      }
      .dark-mode .output-container {
        scrollbar-color: #87cefa #000;
      }
      .output-container::-webkit-scrollbar {
        width: 8px;
      }
      .output-container::-webkit-scrollbar-track {
        background: #fff;
      }
      .dark-mode .output-container::-webkit-scrollbar-track {
        background: #2c2f33;
      }
      .output-container::-webkit-scrollbar-thumb {
        background-color: #1e90ff;
        border-radius: 4px;
        border: 2px solid #fff;
      }
      .dark-mode .output-container::-webkit-scrollbar-thumb {
        border-color: #2c2f33;
        background-color: #87cefa;
      }

      #lottieLoader {
        display: none;
        margin: 1rem auto;
      }

      #output {
        user-select: text;
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        line-height: 1.6;
        color: #333;
        font-size: 0.85rem;
        white-space: pre-wrap;
      }
      .dark-mode #output {
        color: #e0e0e0;
      }
      .copy-button {
        position: sticky;
        bottom: 0.5rem;
        right: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 0.25rem;
        font-size: 0.9rem;
        color: #1e90ff;
        cursor: pointer;
        transition: background 0.3s ease, color 0.3s ease;
        z-index: 10;
        margin-left: auto;
        margin-right: 0;
        display: block;
      }
      .dark-mode .copy-button {
        border-color: #4a4e57;
        color: #87cefa;
      }
      .copy-button:hover {
        background: rgba(255, 255, 255, 0.2);
        color: #00ff7f;
      }
      .dark-mode .copy-button:hover {
        background: rgba(255, 255, 255, 0.2);
        color: #00ff7f;
      }
      .input-container input {
        width: 100%;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid #ccc;
        border-radius: 8px;
        color: #333;
        font-size: 0.9rem;
        transition: border-color 0.3s ease;
      }
      .dark-mode .input-container input {
        background: rgba(40, 44, 52, 0.7);
        border-color: #4a4e57;
        color: #e0e0e0;
      }
      .input-container input:focus {
        border-color: #1e90ff;
        outline: none;
      }
      .send-button {
        background: #1e90ff;
        border-radius: 0;
        padding: 0.5rem 1rem;
        font-size: 0.95rem;
        color: #fff;
        border: none;
        cursor: pointer;
        margin-top: 0.5rem;
        width: 100%;
        transition: background 0.2s ease;
      }
      .dark-mode .send-button {
        background: #1e90ff;
      }
      .send-button:disabled {
        /* background: rgba(255, 255, 255, 0.1); */
        cursor: not-allowed;
      }
      .dark-mode .send-button:disabled {
        background: rgba(0, 0, 0, 0.3);
      }
      .send-button:hover:not(:disabled) {
        background: #00ff7f;
      }
      .dark-mode .send-button:hover:not(:disabled) {
        background: #00ff7f;
      }
      .settings-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        min-width: 300px;
        max-width: 90%;
        z-index: 2000;
        display: none;
        font-family: "Inter", sans-serif;
      }
      .dark-mode .settings-modal {
        background: linear-gradient(135deg, #2c2f33 0%, #1a1d23 100%);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }
      .settings-modal.active {
        display: block;
      }
      .form-group {
        margin-bottom: 0.75rem;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.25rem;
        font-weight: 600;
        color: #333;
        font-size: 0.9rem;
      }
      .dark-mode .form-group label {
        color: #e0e0e0;
      }
      .form-group select {
        width: 100%;
        padding: 0.5rem;
        border: 2px solid #ccc;
        border-radius: 6px;
        font-size: 0.9rem;
        background: #fff;
        transition: border-color 0.3s ease;
      }
      .dark-mode .form-group select {
        background: #2d2d2d;
        border-color: #4a4e57;
        color: #e0e0e0;
      }
      .form-group select:focus {
        border-color: #1e90ff;
        outline: none;
      }
      .error {
        color: #ff6b6b;
        font-size: 0.85rem;
        margin: 0.5rem 0;
        padding: 0.25rem;
        background: rgba(255, 107, 107, 0.1);
        border-radius: 4px;
        display: none;
      }
      .dark-mode .error {
        color: #ff6b6b;
        background: rgba(255, 107, 107, 0.2);
      }
      .error.active {
        display: block;
      }
      @keyframes spin {
        0% {
          transform: translate(-50%, -50%) rotate(0deg);
        }
        100% {
          transform: translate(-50%, -50%) rotate(360deg);
        }
      }

      .input-container input {
        width: 100%;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid #ccc;
        border-radius: 8px;
        color: #333;
        font-size: 0.9rem;
        transition: border-color 0.3s ease;
      }

      .prompt-input {
        width: 100%;
        box-sizing: border-box;
        resize: vertical;
        height: 150px;
        min-height: 100px;
        padding: 5px;
        font-family: "Inter", sans-serif;
        color: black !important;
        background-color: white;
        border-radius: 5px;
        border: 1px solid rgba(104, 104, 104, 0.645);
      }
      .prompt-input::placeholder {
        color: rgba(0, 0, 0, 0.678);
      }

      .prompt-input:focus {
        outline: 1px solid rgba(0, 0, 0, 0.702);
      }
      /* ... existing styles ... */

      /* Mac warning style */
      .mac-warning {
        background: #fff3cd;
        color: #856404;
        padding: 0.5rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        border-left: 3px solid #ffc107;
        font-size: 0.9rem;
      }
      .dark-mode .mac-warning {
        background: #343a40;
        color: #ffc107;
        border-left-color: #ffc107;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Mac-specific warning -->
      <!-- will be inserted dynamically if on Mac -->

      <div class="header">
        <img
          src="https://raw.githubusercontent.com/FlowEdgeSolutions/officeAddin/main/assets/logo80.png"
          alt="MailAider Logo"
          class="logo"
        />
        <h1 class="main-heading">MailAider AI</h1>
        <span class="dark-mode-toggle" onclick="toggleDarkMode()">üåô</span>
      </div>
      <div class="error" id="error"></div>
      <div class="email-viewer">
        <div class="email-header">
          <h2 id="emailSubject">Lade Betreff...</h2>
          <p id="emailSender">Lade Absender...</p>
        </div>
        <div class="summary" id="emailSummary" style="display: none">
          Lade Zusammenfassung...
        </div>
        <button
          class="send-button"
          id="toggleSummaryButton"
          onclick="toggleSummary()"
        >
          Zusammenfassung anzeigen
        </button>
      </div>
      <div class="output-container">
        <dotlottie-player
          id="lottieLoader"
          background="transparent"
          speed="1"
          style="width: 100px; height: 100px; margin: 0 auto; display: none"
          loop
          autoplay
        ></dotlottie-player>
        <div id="output">Warte auf Ausgabe...</div>
        <button class="copy-button" onclick="copyOutputContent()">üìã</button>
      </div>
      <div class="input-container">
        <textarea
          class="prompt-input"
          id="promptInput"
          placeholder="Was soll verarbeitet werden? (optional)"
          rows="4"
        ></textarea>

        <button
          class="send-button"
          id="actionButton"
          onclick="openSettings()"
          disabled
        >
          Lade...
        </button>
      </div>
      <div class="action-buttons">
        <!-- action buttons as before -->
      </div>
      <div class="settings-modal" id="settingsModal">
        <!-- settings modal as before -->
      </div>
    </div>

    <script>
      // Global state
      const errorDiv = document.getElementById("error");
      const actionButton = document.getElementById("actionButton");
      const settingsModal = document.getElementById("settingsModal");
      const emailSummaryDiv = document.getElementById("emailSummary");
      const lottieLoader = document.getElementById("lottieLoader");
      const outputDiv = document.getElementById("output");
      let emailContent = "";
      let emailSubject = "";
      let emailSender = "";
      let mode = "azure";
      let action = "antworten";
      let tone = "formell";
      let language = "German";
      let greeting = "informell";
      let length = "kurz";
      let isContentLoaded = false;

      const isMacOutlook = Office.context.mailbox.diagnostics.hostName === "OutlookMac";

      /**
       * Safe method to get email body on all platforms
       */
      function getEmailBodySafe(callback) {
        try {
          Office.context.mailbox.item.body.getAsync("text", (result) => {
            if (result.status === Office.AsyncResultStatus.Succeeded) {
              callback(result.value || "");
            } else {
              console.warn("Fallback (Mac): Leerer Body.");
              callback("");
            }
          });
        } catch (e) {
          console.error("Mac getAsync Fehler:", e);
          callback("");
        }
      }

      /**
       * Proxy API call to backend (hides sensitive keys)
       */
      async function callProxyAPI(prompt) {
        try {
          const response = await fetch("https://addins.flowedge.de/chatgpt-proxy", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt })
          });
          if (!response.ok) throw new Error("Proxy-Fehler");
          return await response.text();
        } catch (error) {
          console.error("Proxy-API-Fehler:", error);
          return "‚ùå Fehler bei der Verarbeitung. Bitte sp√§ter erneut versuchen.";
        }
      }

      /**
       * Show Mac-specific warning
       */
      function showMacWarning() {
        const warning = document.createElement("div");
        warning.className = "mac-warning";
        warning.innerHTML = `
          <strong>Hinweis f√ºr Mac-Nutzer:</strong>
          Einige Funktionen sind eingeschr√§nkt. Die Verarbeitung erfolgt √ºber einen sicheren Cloud-Proxy.
        `;
        document.querySelector(".container").prepend(warning);

        const modeSelect = document.getElementById("modeSelect");
        if (modeSelect) {
          modeSelect.innerHTML = `<option value="azure">‚ö° Schnell (Proxy)</option>`;
        }
      }

      /**
       * Handle submit from settings modal
       */
      async function handleSubmitFromModal() {
        const promptInput = document.getElementById("promptInput").value;
        outputDiv.innerText = "";
        lottieLoader.style.display = "block";

        if (!emailContent && !promptInput) {
          outputDiv.innerText = "‚ùå Kein Inhalt verf√ºgbar";
          lottieLoader.style.display = "none";
          return;
        }

        // Build prompt
        let fullPrompt = promptInput;
        if (action === "zusammenfassen") {
          fullPrompt = `Fasse diese E-Mail in Stichpunkten zusammen (‚óè statt -):\n${emailContent}`;
        } else if (action === "antworten") {
          fullPrompt = `Antworte auf diese E-Mail (${tone} Ton, ${greeting} Anrede, ${length}):\n${emailContent}`;
        } else if (action === "√ºbersetzen") {
          fullPrompt = `√úbersetze ins ${language}:\n${emailContent}`;
        }

        // Choose API method
        const apiCall = callProxyAPI;
        const response = await apiCall(fullPrompt);
        outputDiv.innerText = response;
        lottieLoader.style.display = "none";
        settingsModal.classList.remove("active");
      }

      /**
       * Initialisation
       */
      Office.onReady(() => {
        console.log("Office.js geladen auf Mac?", isMacOutlook);
        if (isMacOutlook) showMacWarning();

        if (!Office.context.mailbox?.item) {
          return console.error("Keine E-Mail ausgew√§hlt");
        }

        const item = Office.context.mailbox.item;
        document.getElementById("emailSubject").innerText = item.subject || "Kein Betreff";
        document.getElementById("emailSender").innerText = "Von: " + (item.from?.displayName || item.from?.emailAddress || "Unbekannt");

        // Load and summarize body
        getEmailBodySafe((body) => {
          emailContent = body;
          if (isMacOutlook) {
            callProxyAPI(`Fasse diese E-Mail in 4 Stichpunkten zusammen (‚óè statt -):\n${body}`)
              .then((summary) => {
                emailSummaryDiv.innerText = summary;
                emailSummaryDiv.style.display = "block";
                actionButton.disabled = false;
                actionButton.textContent = "Antwort formulieren";
              });
          } else {
            // Existing Azure summary
            summarizeEmail().then(() => {
              emailSummaryDiv.style.display = "block";
              actionButton.disabled = false;
              actionButton.textContent = "Antwort formulieren";
            });
          }
        });
      });
    </script>
  </body>
</html>
