<!DOCTYPE html>
<html>
  <head>
    <title>MailAider</title>
    <meta charset="UTF-8" />
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script
      src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs"
      type="module"
    ></script>

<style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        line-height: 1.5;
        font-weight: 400;
        color: #333;
        background: #fff;
        padding: 0.25rem;
        max-width: 350px;
        margin: 0 auto;
        transition: background 0.3s;
      }
      .dark-mode {
        background: linear-gradient(135deg, #2c2f33 0%, #1a1d23 100%);
        color: #e0e0e0;
      }
      .dark-mode .container {
        background: rgba(44, 47, 51, 0.9);
        border-color: #4a4e57;
      }
      .dark-mode .email-viewer,
      .dark-mode .output-container,
      .dark-mode .input-container {
        background: rgba(34, 37, 41, 0.7);
        border-color: #4a4e57;
      }
      .dark-mode .email-body,
      .dark-mode .summary,
      .dark-mode #output {
        background: rgba(40, 44, 52, 0.5);
        border-color: #4a4e57;
      }
      .dark-mode .input-container input,
      .dark-mode select {
        background: rgba(40, 44, 52, 0.7);
        border-color: #4a4e57;
        color: #e0e0e0;
      }
      .dark-mode .send-button {
        background: #1e90ff;
      }
      .dark-mode .send-button:hover:not(:disabled) {
        background: #87cefa;
      }
      .dark-mode .copy-button {
        background: rgba(255, 255, 255, 0.1);
        color: #1e90ff;
      }
      .dark-mode .copy-button:hover {
        background: rgba(255, 255, 255, 0.2);
        color: #87cefa;
      }
      .container {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 0.5rem;
      }
      .header {
        position: relative;
        padding: 0.5rem;
        border-bottom: 1px solid #ccc;
        text-align: center;
        display: flex;
        align-items: center;
      }
      .logo {
        width: 30px;
        height: auto;
        margin-right: 0.5rem;
      }
      .main-heading {
        font-family: "Franklin Gothic Medium", "Arial Narrow", Arial, sans-serif;
        font-size: 1.4rem;
        font-weight: 800;
        letter-spacing: -0.02em;
        color: #1e90ff;
      }
      .dark-mode .main-heading {
        color: #87cefa;
      }
      .dark-mode-toggle {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        font-size: 1.2rem;
        cursor: pointer;
        color: #1e90ff;
      }
      .dark-mode .dark-mode-toggle {
        color: #87cefa;
      }
      .action-buttons {
        display: flex;
        justify-content: space-between;
        margin: 0.5rem 0;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
      }
      .dark-mode .action-buttons {
        background: rgba(34, 37, 41, 0.7);
        border-color: #4a4e57;
        box-shadow: 0 3px 15px rgba(0, 240, 255, 0.1);
      }
      .action-button {
        background: none;
        border: none;
        padding: 0.5rem;
        font-size: 1.5rem;
        color: #1e90ff;
        cursor: pointer;
        transition: color 0.2s ease;
        flex: 1;
        text-align: center;
        border-right: 1px solid #ccc;
        position: relative;
      }
      .dark-mode .action-button {
        color: #87cefa;
      }
      .action-button:hover {
        color: #00ff7f;
      }
      .action-button:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        top: -2.5rem;
        left: 50%;
        transform: translateX(-50%);
        background: #1e90ff;
        color: #fff;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        white-space: nowrap;
      }
      .dark-mode .action-button:hover {
        color: #00ff7f;
      }
      .action-button:last-child {
        border-right: none;
      }
      .email-viewer,
      .output-container,
      .input-container {
        padding: 0.5rem;
        margin: 0.5rem 0;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        border: 1px solid #ccc;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
      }
      .dark-mode .email-viewer,
      .dark-mode .output-container,
      .dark-mode .input-container {
        background: rgba(34, 37, 41, 0.7);
        border-color: #4a4e57;
        box-shadow: 0 3px 15px rgba(0, 240, 255, 0.1);
      }
      .email-header {
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #ccc;
      }
      .dark-mode .email-header {
        border-bottom-color: #4a4e57;
      }
      .email-header h2 {
        font-weight: 700;
        color: #333;
        font-size: 1rem;
      }
      .dark-mode .email-header h2 {
        color: #e0e0e0;
      }
      .email-header p {
        color: #666;
        font-size: 0.85rem;
        margin: 0;
      }
      .dark-mode .email-header p {
        color: #a0a0a0;
      }
      .email-body {
        margin-top: 0.5rem;
        line-height: 1.6;
        color: #333;
        font-size: 0.85rem;
        white-space: pre-wrap;
        background: rgba(255, 255, 255, 0.05);
        padding: 0.5rem;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        height: 200px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #1e90ff #fff;
        display: none;
      }
      .dark-mode .email-body {
        color: #e0e0e0;
        background: rgba(40, 44, 52, 0.5);
        border-color: #4a4e57;
        scrollbar-color: #87cefa #000;
      }
      .email-body.active {
        display: block;
      }
      .email-body::-webkit-scrollbar {
        width: 8px;
      }
      .email-body::-webkit-scrollbar-track {
        background: #fff;
      }
      .dark-mode .email-body::-webkit-scrollbar-track {
        background: #2c2f33;
      }
      .email-body::-webkit-scrollbar-thumb {
        background-color: #1e90ff;
        border-radius: 4px;
        border: 2px solid #fff;
      }
      .dark-mode .email-body::-webkit-scrollbar-thumb {
        border-color: #2c2f33;
        background-color: #87cefa;
      }
      .summary {
        margin-top: 0.5rem;
        line-height: 1.6;
        color: #333;
        font-size: 0.85rem;
        white-space: pre-wrap;
        background: rgba(255, 255, 255, 0.05);
        padding: 0.5rem;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #1e90ff #fff;
      }
      .dark-mode .summary {
        color: #e0e0e0;
        background: rgba(40, 44, 52, 0.5);
        border-color: #4a4e57;
        scrollbar-color: #87cefa #000;
      }
      .summary::-webkit-scrollbar {
        width: 8px;
      }
      .summary::-webkit-scrollbar-track {
        background: #fff;
      }
      .dark-mode .summary::-webkit-scrollbar-track {
        background: #2c2f33;
      }
      .summary::-webkit-scrollbar-thumb {
        background-color: #1e90ff;
        border-radius: 4px;
        border: 2px solid #fff;
      }
      .dark-mode .summary::-webkit-scrollbar-thumb {
        border-color: #2c2f33;
        background-color: #87cefa;
      }
      .show-full-email {
        background: #1e90ff;
        border: none;
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
        color: #fff;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 0.25rem;
        width: auto;
        transition: background 0.2s ease;
      }
      .dark-mode .show-full-email {
        background: #1e90ff;
      }
      .show-full-email:hover {
        background: #00ff7f;
      }
      .dark-mode .show-full-email:hover {
        background: #00ff7f;
      }
      .output-container {
        height: 250px;
        overflow-y: auto;
        position: relative;
        padding: 0.5rem;
        scrollbar-width: thin;
        scrollbar-color: #1e90ff #fff;
      }
      .dark-mode .output-container {
        scrollbar-color: #87cefa #000;
      }
      .output-container::-webkit-scrollbar {
        width: 8px;
      }
      .output-container::-webkit-scrollbar-track {
        background: #fff;
      }
      .dark-mode .output-container::-webkit-scrollbar-track {
        background: #2c2f33;
      }
      .output-container::-webkit-scrollbar-thumb {
        background-color: #1e90ff;
        border-radius: 4px;
        border: 2px solid #fff;
      }
      .dark-mode .output-container::-webkit-scrollbar-thumb {
        border-color: #2c2f33;
        background-color: #87cefa;
      }

      #lottieLoader {
        display: none;
        margin: 1rem auto;
      }

      #output {
        user-select: text;
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        line-height: 1.6;
        color: #333;
        font-size: 0.85rem;
        white-space: pre-wrap;
      }
      .dark-mode #output {
        color: #e0e0e0;
      }
      .copy-button {
        position: sticky;
        bottom: 0.5rem;
        right: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 0.25rem;
        font-size: 0.9rem;
        color: #1e90ff;
        cursor: pointer;
        transition: background 0.3s ease, color 0.3s ease;
        z-index: 10;
        margin-left: auto;
        margin-right: 0;
        display: block;
      }
      .dark-mode .copy-button {
        border-color: #4a4e57;
        color: #87cefa;
      }
      .copy-button:hover {
        background: rgba(255, 255, 255, 0.2);
        color: #00ff7f;
      }
      .dark-mode .copy-button:hover {
        background: rgba(255, 255, 255, 0.2);
        color: #00ff7f;
      }
      .input-container input {
        width: 100%;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid #ccc;
        border-radius: 8px;
        color: #333;
        font-size: 0.9rem;
        transition: border-color 0.3s ease;
      }
      .dark-mode .input-container input {
        background: rgba(40, 44, 52, 0.7);
        border-color: #4a4e57;
        color: #e0e0e0;
      }
      .input-container input:focus {
        border-color: #1e90ff;
        outline: none;
      }
      .send-button {
        background: #1e90ff;
        border-radius: 0;
        padding: 0.5rem 1rem;
        font-size: 0.95rem;
        color: #fff;
        border: none;
        cursor: pointer;
        margin-top: 0.5rem;
        width: 100%;
        transition: background 0.2s ease;
      }
      .dark-mode .send-button {
        background: #1e90ff;
      }
      .send-button:disabled {
        /* background: rgba(255, 255, 255, 0.1); */
        cursor: not-allowed;
      }
      .dark-mode .send-button:disabled {
        background: rgba(0, 0, 0, 0.3);
      }
      .send-button:hover:not(:disabled) {
        background: #00ff7f;
      }
      .dark-mode .send-button:hover:not(:disabled) {
        background: #00ff7f;
      }
      .settings-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        min-width: 300px;
        max-width: 90%;
        z-index: 2000;
        display: none;
        font-family: "Inter", sans-serif;
      }
      .dark-mode .settings-modal {
        background: linear-gradient(135deg, #2c2f33 0%, #1a1d23 100%);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }
      .settings-modal.active {
        display: block;
      }
      .form-group {
        margin-bottom: 0.75rem;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.25rem;
        font-weight: 600;
        color: #333;
        font-size: 0.9rem;
      }
      .dark-mode .form-group label {
        color: #e0e0e0;
      }
      .form-group select {
        width: 100%;
        padding: 0.5rem;
        border: 2px solid #ccc;
        border-radius: 6px;
        font-size: 0.9rem;
        background: #fff;
        transition: border-color 0.3s ease;
      }
      .dark-mode .form-group select {
        background: #2d2d2d;
        border-color: #4a4e57;
        color: #e0e0e0;
      }
      .form-group select:focus {
        border-color: #1e90ff;
        outline: none;
      }
      .error {
        color: #ff6b6b;
        font-size: 0.85rem;
        margin: 0.5rem 0;
        padding: 0.25rem;
        background: rgba(255, 107, 107, 0.1);
        border-radius: 4px;
        display: none;
      }
      .dark-mode .error {
        color: #ff6b6b;
        background: rgba(255, 107, 107, 0.2);
      }
      .error.active {
        display: block;
      }
      @keyframes spin {
        0% {
          transform: translate(-50%, -50%) rotate(0deg);
        }
        100% {
          transform: translate(-50%, -50%) rotate(360deg);
        }
      }

      .input-container input {
        width: 100%;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid #ccc;
        border-radius: 8px;
        color: #333;
        font-size: 0.9rem;
        transition: border-color 0.3s ease;
      }

      .prompt-input {
        width: 100%;
        box-sizing: border-box;
        resize: vertical;
        height: 150px;
        min-height: 100px;
        padding: 5px;
        font-family: "Inter", sans-serif;
        color: black !important;
        background-color: white;
        border-radius: 5px;
        border: 1px solid rgba(104, 104, 104, 0.645);
      }
      .prompt-input::placeholder {
        color: rgba(0, 0, 0, 0.678);
      }

      .prompt-input:focus {
        outline: 1px solid rgba(0, 0, 0, 0.702);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <img
          src="https://raw.githubusercontent.com/FlowEdgeSolutions/officeAddin/main/assets/logo80.png"
          alt="MailAider Logo"
          class="logo"
        />
        <h1 class="main-heading">MailAider AI</h1>
        <span class="dark-mode-toggle" onclick="toggleDarkMode()">🌙</span>
      </div>
      <div class="error" id="error"></div>
      <div class="email-viewer">
        <div class="email-header">
          <h2 id="emailSubject">Lade Betreff...</h2>
          <p id="emailSender">Lade Absender...</p>
        </div>
        <div class="summary" id="emailSummary" style="display: none">
          Lade Zusammenfassung...
        </div>
        <button
          class="send-button"
          id="toggleSummaryButton"
          onclick="toggleSummary()"
        >
          Zusammenfassung anzeigen
        </button>
      </div>
      <div class="output-container">
        <dotlottie-player
          id="lottieLoader"
          src="https://lottie.host/c50dbde0-250a-43a1-8493-de801fb3caf5/zs2kPt4Uv9.lottie"
          background="transparent"
          speed="1"
          style="width: 100px; height: 100px; margin: 0 auto; display: none"
          loop
          autoplay
        ></dotlottie-player>
        <div id="output">Warte auf Ausgabe...</div>
        <button class="copy-button" onclick="copyOutputContent()">📋</button>
      </div>
      <div class="input-container">
        <textarea
          class="prompt-input"
          id="promptInput"
          placeholder="Was soll verarbeitet werden? (optional)"
          rows="4"
        ></textarea>

        <button
          class="send-button"
          id="actionButton"
          onclick="openSettings()"
          disabled
        >
          Lade...
        </button>
      </div>
      <div class="action-buttons">
        <button
          class="action-button"
          onclick="setAction('zusammenfassen')"
          data-tooltip="Zusammenfassen"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 0 1 .865-.501 48.172 48.172 0 0 0 3.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0 0 12 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018Z"/>
          </svg>
        </button>
        <button
          class="action-button"
          onclick="setAction('antworten')"
          data-tooltip="Antworten"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"/>
          </svg>
        </button>
        <button
          class="action-button"
          onclick="setAction('übersetzen')"
          data-tooltip="Übersetzen"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="m10.5 21 5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 0 1 6-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C11.176 10.658 7.69 15.08 3 17.502m9.334-12.138c.896.061 1.785.147 2.666.257m-4.589 8.495a18.023 18.023 0 0 1-3.827-5.802"/>
          </svg>
        </button>
        <button
          class="action-button"
          onclick="setAction('freierModus')"
          data-tooltip="Freier Modus"
        >
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V6.75a4.5 4.5 0 1 1 9 0v3.75M3.75 21.75h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H3.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z"/>
          </svg>
        </button>
      </div>
      <div class="settings-modal" id="settingsModal">
        <div class="form-group" id="modeGroup">
          <label>Verarbeitung:</label>
          <select id="modeSelect" onchange="updateSettings()">
            <option value="azure">⚡ Schnell (Azure)</option>
            <option value="ollama">🔒 Datenschutz (Ollama)</option>
          </select>
        </div>
        <div class="form-group" id="toneGroup" style="display: none">
          <label>Tonfall:</label>
          <select id="toneSelect">
            <option value="formell">Formell</option>
            <option value="informell">Informell</option>
            <option value="höflich">Höflich</option>
            <option value="direkt">Direkt & prägnant</option>
          </select>
        </div>
        <div class="form-group" id="greetingGroup" style="display: none">
          <label>Anrede:</label>
          <select id="greetingSelect">
            <option value="informell">Du (informell)</option>
            <option value="formell">Sie (formell)</option>
          </select>
        </div>
        <div class="form-group" id="lengthGroup" style="display: none">
          <label>Länge:</label>
          <select id="lengthSelect">
            <option value="kurz">Kurz</option>
            <option value="mittel">Mittel</option>
            <option value="lang">Lang</option>
          </select>
        </div>
        <div class="form-group" id="languageGroup" style="display: none">
          <label>Zielsprache:</label>
          <select id="languageSelect">
            <option value="deutsch">Deutsch</option>
            <option value="englisch">Englisch</option>
            <option value="französisch">Französisch</option>
            <option value="italienisch">Italienisch</option>
          </select>
        </div>
        <button
          class="send-button"
          id="submitModal"
          onclick="handleSubmitFromModal()"
        >
          Ausführen
        </button>
        <button class="send-button" onclick="closeSettings()">Schließen</button>
      </div>
    </div>
    <script>
      // Konfiguration und Zustand
      const errorDiv = document.getElementById("error");
      const actionButton = document.getElementById("actionButton");
      const settingsModal = document.getElementById("settingsModal");
      const emailSummaryDiv = document.getElementById("emailSummary");
      const lottieLoader = document.getElementById("lottieLoader");
      const outputDiv = document.getElementById("output");
      const outputContainer = outputDiv.parentElement;

      let emailContent = "";
      let emailSubject = "";
      let emailSender = "";
      let mode = "azure";
      let action = "antworten";
      let tone = "formell";
      let language = "deutsch";
      let greeting = "informell";
      let length = "kurz";
      let isContentLoaded = false;
      
      // NEU: Plattformerkenung
      const isMacOutlook = Office.context.mailbox.diagnostics.hostName === "OutlookMac";

      // Funktionen
      function logError(message) {
        const errorInfo = {
          message,
          platform: Office.context.mailbox.diagnostics.hostName,
          version: Office.context.mailbox.diagnostics.hostVersion,
          time: new Date().toISOString()
        };
        console.error("Fehlerprotokoll:", JSON.stringify(errorInfo));
        errorDiv.innerHTML = `Fehler: ${message}<br><small>${errorInfo.platform} ${errorInfo.version}</small>`;
        errorDiv.classList.add("active");
      }

      function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
      }

      function openSettings() {
        if (isContentLoaded) {
          settingsModal.classList.add("active");
          document.getElementById("modeSelect").value = mode;
          updateSettings();
        }
      }

      function closeSettings() {
        settingsModal.classList.remove("active");
      }

      function mapLanguage(lang) {
        const languageMap = {
          deutsch: "German",
          englisch: "English",
          französisch: "French",
          italienisch: "Italian"
        };
        return languageMap[lang] || lang;
      }

      function setAction(newAction) {
        action = newAction;
        actionButton.textContent =
          action === "zusammenfassen" ? "Zusammenfassen" :
          action === "antworten" ? "Antworten formulieren" :
          action === "übersetzen" ? "Übersetzen" : "Freier Modus";
        if (isContentLoaded) actionButton.disabled = false;
        updateSettings();
      }

      function updateSettings() {
        mode = document.getElementById("modeSelect").value;
        document.getElementById("toneGroup").style.display = action === "antworten" ? "block" : "none";
        document.getElementById("greetingGroup").style.display = action === "antworten" ? "block" : "none";
        document.getElementById("lengthGroup").style.display = action === "antworten" ? "block" : "none";
        document.getElementById("languageGroup").style.display = action === "übersetzen" ? "block" : "none";

        if (action === "antworten") {
          tone = document.getElementById("toneSelect").value;
          greeting = document.getElementById("greetingSelect").value;
          length = document.getElementById("lengthSelect").value;
        } else if (action === "übersetzen") {
          language = mapLanguage(document.getElementById("languageSelect").value);
        }
      }

      function toggleSummary() {
        const summary = document.getElementById("emailSummary");
        const btn = document.getElementById("toggleSummaryButton");
        if (summary.style.display === "none") {
          summary.style.display = "block";
          btn.innerText = "Zusammenfassung verbergen";
        } else {
          summary.style.display = "none";
          btn.innerText = "Zusammenfassung anzeigen";
        }
      }

      function copyOutputContent() {
        const text = outputDiv.innerText;
        navigator.clipboard.writeText(text).then(() => {
          const copyBtn = document.querySelector(".copy-button");
          copyBtn.textContent = "✓ Kopiert!";
          setTimeout(() => copyBtn.textContent = "📋", 2000);
        }).catch(err => {
          console.error("Kopieren fehlgeschlagen:", err);
        });
      }

      // NEU: Verbesserte API-Funktion mit Mac-Fallback
      async function callAzure(prompt) {
        try {
          const apiUrl = isMacOutlook 
            ? "https://addins.flowedge.de/chatgpt-proxy"
            : "https://openaiaddinapi.openai.azure.com/openai/deployments/gpt-4o_MailAiderAi_OutlookAddIn/chat/completions?api-version=2025-01-01-preview";

          const headers = {
            "Content-Type": "application/json",
            ...(isMacOutlook ? {} : {
              "api-key": "9psvVslPXfp4xbJ9SzRXpfx9E9lP8TLiFcC3IZgf43RLNQA9RiV4JQQJ99BFACI8hq2XJ3w3AAABACOGHQcr"
            })
          };

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: headers,
            body: JSON.stringify({
              messages: [
                {
                  role: "system",
                  content: "Du bist ein E-Mail-Assistent. Verwende immer die Schweizer Rechtschreibung."
                },
                { role: "user", content: prompt }
              ],
              temperature: 0.6
            })
          });

          if (!response.ok) {
            throw new Error(`API-Fehler: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();
          return data.choices?.[0]?.message?.content || "❌ Keine Antwort erhalten.";

        } catch (error) {
          console.error("API Fehler:", error);
          return isMacOutlook
            ? "❌ Verbindungsproblem (Mac). Bitte versuchen Sie es später erneut."
            : `❌ Fehler: ${error.message}`;
        }
      }

      async function callLokal(prompt) {
        try {
          const response = await fetch("http://localhost:11434/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              model: "nous-hermes2",
              messages: [
                {
                  role: "system",
                  content: "Rolle: Professioneller E-Mail-Assistent mit Schweizer Rechtschreibung."
                },
                { role: "user", content: prompt }
              ],
              stream: false
            })
          });
          const data = await response.json();
          return data.message?.content || "❌ Keine Antwort erhalten.";
        } catch (error) {
          return "❌ Lokaler Fehler: " + error.message;
        }
      }

      // NEU: Verbessertes Submit-Handling
      async function handleSubmitFromModal() {
        const promptInput = document.getElementById("promptInput").value;
        outputDiv.innerText = "";
        lottieLoader.style.display = "block";
        outputContainer.classList.add("processing");

        if (!emailContent && !promptInput) {
          outputDiv.innerText = "❌ Kein Inhalt verfügbar";
          outputContainer.classList.remove("processing");
          return;
        }

        try {
          const emailText = emailContent ? `Kontext: ${emailContent}\n` : "";
          let fullPrompt = promptInput || "";

          if (action === "zusammenfassen") {
            fullPrompt = `Fasse diese E-Mail in Stichpunkten zusammen (● statt -):\n${emailText}${promptInput}`;
          } else if (action === "antworten") {
            fullPrompt = `Antworte auf diese E-Mail (${tone} Ton, ${greeting} Anrede, ${length}):\n${emailText}${promptInput}`;
          } else if (action === "übersetzen") {
            fullPrompt = `Übersetze ins ${mapLanguage(language)}:\n${emailText}${promptInput}`;
          }

          const apiCall = mode === "azure" ? callAzure : callLokal;
          
          // NEU: Timeout für Mac
          const response = isMacOutlook
            ? await Promise.race([
                apiCall(fullPrompt),
                new Promise((_, reject) => 
                  setTimeout(() => reject(new Error("Timeout nach 20s")), 20000))
              ])
            : await apiCall(fullPrompt);

          outputDiv.innerText = response;

        } catch (error) {
          logError(error.message);
          outputDiv.innerText = isMacOutlook
            ? "❌ Mac-spezifischer Fehler: " + error.message
            : "❌ Fehler: " + error.message;
        } finally {
          lottieLoader.style.display = "none";
          outputContainer.classList.remove("processing");
          closeSettings();
        }
      }

      async function summarizeEmail() {
        if (emailContent) {
          const response = await callAzure(
            `Fasse diese E-Mail in 4 Stichpunkten zusammen (● statt -):\n${emailContent}`
          );
          emailSummaryDiv.innerText = response || "Keine Zusammenfassung verfügbar.";
        }
      }

      // Initialisierung
      Office.onReady((info) => {
        console.log("Office.js geladen auf:", info.host, info.platform);
        
        if (!Office.context.mailbox?.item) {
          return logError("Keine E-Mail ausgewählt");
        }

        const item = Office.context.mailbox.item;
        const isOutlookWeb = info.platform === "OfficeOnline";

        // Betreff und Absender laden
        if (isOutlookWeb) {
          emailSubject = item.subject || "Kein Betreff";
          emailSender = item.from?.displayName || item.from?.emailAddress || "Unbekannt";
        } else {
          item.subject.getAsync(result => {
            emailSubject = result.status === Office.AsyncResultStatus.Succeeded 
              ? result.value || "Kein Betreff" 
              : "Betreff nicht verfügbar";
            document.getElementById("emailSubject").innerText = emailSubject;
          });
          
          item.from.getAsync(result => {
            emailSender = result.status === Office.AsyncResultStatus.Succeeded
              ? result.value.displayName || result.value.emailAddress || "Unbekannt"
              : "Absender nicht verfügbar";
            document.getElementById("emailSender").innerText = "Von: " + emailSender;
          });
        }

        document.getElementById("emailSubject").innerText = emailSubject;
        document.getElementById("emailSender").innerText = "Von: " + emailSender;

        // E-Mail-Inhalt laden
        item.body.getAsync("text", result => {
          if (result.status === Office.AsyncResultStatus.Succeeded) {
            emailContent = result.value || "";
            summarizeEmail().then(() => {
              isContentLoaded = true;
              actionButton.disabled = false;
              actionButton.textContent =
                action === "zusammenfassen" ? "Zusammenfassen" :
                action === "antworten" ? "Antwort formulieren" :
                action === "übersetzen" ? "Übersetzen" : "Freier Modus";
            });
          } else {
            logError("E-Mail-Inhalt konnte nicht geladen werden");
          }
        });

      }).catch(error => {
        logError("Office.js Fehler: " + error.message);
      });

      // NEU: CORS-Prüfung für Mac beim Start
      if (isMacOutlook) {
        fetch("https://addins.flowedge.de", { method: "OPTIONS" })
          .catch(e => console.warn("CORS-Prüfung fehlgeschlagen:", e));
      }
    </script>
  </body>
</html>
