<!DOCTYPE html>
<html>
  <head>
    <title>MailAider AI 4.0</title>
    <meta charset="UTF-8" />
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script
      src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs"
      type="module"
    ></script>

    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        line-height: 1.5; font-weight: 400; color: #333;
        background: #fff; padding: 0.25rem; max-width: 350px; margin: 0 auto;
        transition: background 0.3s;
      }
      .dark-mode {
        background: linear-gradient(135deg,#2c2f33 0%,#1a1d23 100%); color:#e0e0e0;
      }
      .container {
        background: rgba(255,255,255,0.8); border:1px solid #ccc; border-radius:8px;
        padding:0.5rem;
      }
      .header {
        display:flex; align-items:center; position:relative;
        padding:0.5rem; border-bottom:1px solid #ccc;
      }
      .logo { width:30px; height:auto; margin-right:0.5rem; }
      .main-heading {
        font-family:"Franklin Gothic Medium","Arial Narrow",Arial,sans-serif;
        font-size:1.4rem; font-weight:800; letter-spacing:-0.02em; color:#1e90ff;
      }
      .dark-mode .main-heading { color:#87cefa; }
      .header dotlottie-player { margin-left:0.5rem; }
      .dark-mode-toggle {
        position:absolute; top:0.5rem; right:0.5rem; font-size:1.2rem;
        cursor:pointer; color:#1e90ff;
      }
      .dark-mode .dark-mode-toggle { color:#87cefa; }

      .error {
        color:#ff6b6b; font-size:0.85rem; margin:0.5rem 0;
        padding:0.25rem; background:rgba(255,107,107,0.1);
        border-radius:4px; display:none;
      }
      .error.active { display:block; }
      .dark-mode .error { background:rgba(255,107,107,0.2); }

      .email-viewer, .output-container, .input-container {
        padding:0.5rem; margin:0.5rem 0;
        background:rgba(255,255,255,0.1); border-radius:8px;
        border:1px solid #ccc; box-shadow:0 3px 15px rgba(0,0,0,0.1);
      }
      .dark-mode .email-viewer,
      .dark-mode .output-container,
      .dark-mode .input-container {
        background:rgba(34,37,41,0.7); border-color:#4a4e57;
        box-shadow:0 3px 15px rgba(0,240,255,0.1);
      }

      .email-header { padding-bottom:0.5rem; border-bottom:1px solid #ccc; }
      .dark-mode .email-header { border-bottom-color:#4a4e57; }
      .email-header h2 { font-weight:700; color:#333; font-size:1rem; }
      .dark-mode .email-header h2 { color:#e0e0e0; }
      .email-header p { color:#666; font-size:0.85rem; margin:0; }
      .dark-mode .email-header p { color:#a0a0a0; }

      .email-body {
        margin-top:0.5rem; line-height:1.6; color:#333; font-size:0.85rem;
        white-space:pre-wrap; background:rgba(255,255,255,0.05);
        padding:0.5rem; border-radius:6px; border:1px solid rgba(255,255,255,0.05);
        height:200px; overflow-y:auto; display:none;
      }
      .email-body.active { display:block; }
      .dark-mode .email-body {
        color:#e0e0e0; background:rgba(40,44,52,0.5); border-color:#4a4e57;
      }

      .summary {
        margin-top:0.5rem; line-height:1.6; color:#333; font-size:0.85rem;
        white-space:pre-wrap; background:rgba(255,255,255,0.05);
        padding:0.5rem; border-radius:6px; border:1px solid rgba(255,255,255,0.05);
        display:none;
      }
      .dark-mode .summary { color:#e0e0e0; background:rgba(40,44,52,0.5); border-color:#4a4e57; }

      .send-button {
        background:#1e90ff; color:#fff; border:none; padding:0.5rem 1rem;
        font-size:0.95rem; cursor:pointer; width:100%; margin-top:0.5rem;
        transition:background 0.2s ease;
      }
      .send-button:disabled { cursor:not-allowed; background:rgba(0,0,0,0.3); }
      .send-button:hover:not(:disabled) { background:#00ff7f; }
      .dark-mode .send-button { background:#1e90ff; }
      .dark-mode .send-button:hover:not(:disabled) { background:#00ff7f; }

      .action-buttons {
        display:flex; justify-content:space-between; margin:0.5rem 0;
        padding:0.5rem; background:rgba(255,255,255,0.1);
        border:1px solid #ccc; border-radius:8px;
      }
      .dark-mode .action-buttons { background:rgba(34,37,41,0.7); }

      .action-button {
        flex:1; text-align:center; padding:0.5rem; font-size:1.5rem;
        border:none; background:none; color:#1e90ff; cursor:pointer;
        position:relative; border-right:1px solid #ccc;
      }
      .action-button:last-child { border-right:none; }
      .action-button:hover::after {
        content:attr(data-tooltip); position:absolute; top:-2.5rem;
        left:50%; transform:translateX(-50%);
        background:#1e90ff; color:#fff; padding:0.25rem 0.5rem;
        border-radius:4px; font-size:0.8rem; white-space:nowrap;
      }
      .dark-mode .action-button { color:#87cefa; }
      .action-button:hover { color:#00ff7f; }

      .output-container { position:relative; height:250px; overflow-y:auto; }
      #lottieLoader {
        display:none; width:100px; height:100px; margin:1rem auto;
      }
      #output {
        white-space:pre-wrap; line-height:1.6; color:#333; font-size:0.85rem;
      }
      .dark-mode #output { color:#e0e0e0; }

      .copy-button {
        position:sticky; bottom:0.5rem; right:0.5rem;
        background:rgba(255,255,255,0.1); border:1px solid #ccc; border-radius:4px;
        padding:0.25rem; font-size:0.9rem; color:#1e90ff; cursor:pointer;
        z-index:10;
      }
      .copy-button:hover { background:rgba(255,255,255,0.2); color:#00ff7f; }
      .dark-mode .copy-button { color:#87cefa; }

      .input-container textarea {
        width:100%; box-sizing:border-box; resize:vertical;
        min-height:100px; padding:5px; font-family:"Inter",sans-serif;
        background:#fff; border:1px solid rgba(104,104,104,0.65);
        border-radius:5px; color:#000;
      }
      .input-container textarea:focus { outline:1px solid rgba(0,0,0,0.7); }

      .settings-modal {
        position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
        background:#fff; padding:1.5rem; border-radius:12px;
        box-shadow:0 4px 6px rgba(0,0,0,0.1); display:none; z-index:2000;
      }
      .dark-mode .settings-modal {
        background:linear-gradient(135deg,#2c2f33 0%,#1a1d23 100%);
        box-shadow:0 4px 6px rgba(0,0,0,0.3);
      }
      .settings-modal.active { display:block; }
      .form-group { margin-bottom:0.75rem; }
      .form-group label { display:block; margin-bottom:0.25rem; font-weight:600; }
    </style>
  </head>

  <body>
    <!-- Popup -->
    <div id="customPopup" style="display:none;
         position:fixed;top:0;left:0;width:100%;height:100%;
         background:rgba(0,0,0,0.5);z-index:1000;
         justify-content:center;align-items:center;">
      <div style="background:white;padding:20px;border-radius:8px;
           max-width:80%;max-height:80%;overflow:auto;">
        <div id="popupContent"></div>
        <button onclick="hidePopup()"
                style="margin-top:15px;padding:5px 10px;
                       background:#1e90ff;color:white;
                       border:none;border-radius:4px;cursor:pointer;">
          Schlie√üen
        </button>
      </div>
    </div>

    <div class="container">
      <div class="header">
        <img src="https://raw.githubusercontent.com/FlowEdgeSolutions/officeAddin/refs/heads/main/assets/logo80.png"
             alt="MailAider Logo" class="logo" />
        <h1 class="main-heading">MailAider AI 4.0</h1>
        <!-- Header Loading Lottie -->
        <dotlottie-player id="lottieHeaderLoading"
          src="https://lottie.host/ca615a42-7026-46ed-8ad3-5d1d3be3bee4/jRk8P0eZ6D.lottie"
          background="transparent" speed="1"
          style="width:30px;height:30px;display:none" loop autoplay>
        </dotlottie-player>
        <!-- Header Ready Lottie -->
        <dotlottie-player id="lottieHeaderReady"
          src="https://lottie.host/c92a8a5d-1a9b-4e79-968c-ccd370fdcbb3/K6ZUSuXQTS.lottie"
          background="transparent" speed="1"
          style="width:30px;height:30px;display:none" loop autoplay>
        </dotlottie-player>
        <span class="dark-mode-toggle" onclick="toggleDarkMode()">üåô</span>
      </div>

      <div class="error" id="error"></div>

      <div class="email-viewer">
        <div class="email-header">
          <h2 id="emailSubject">Lade Betreff...</h2>
          <p id="emailSender">Lade Absender...</p>
        </div>
        <div class="summary" id="emailSummary">Lade Zusammenfassung...</div>
        <button class="send-button" id="toggleSummaryButton"
                onclick="toggleSummary()">Zusammenfassung anzeigen</button>
      </div>

      <div class="output-container">
        <dotlottie-player id="lottieLoader"
          src="https://lottie.host/c50dbde0-250a-43a1-8493-de801fb3caf5/zs2kPt4Uv9.lottie"
          background="transparent" speed="1"
          style="display:none" loop autoplay>
        </dotlottie-player>
        <div id="output">Warte auf Ausgabe...</div>
        <button class="copy-button" onclick="copyOutputContent()">üìã</button>
      </div>

      <div class="input-container">
        <textarea id="promptInput"
                  placeholder="Was soll verarbeitet werden? (optional)"
                  rows="4"></textarea>
        <button class="send-button" id="actionButton"
                onclick="openSettings()" disabled>Lade...</button>
      </div>

      <div class="action-buttons">
        <button class="action-button" data-tooltip="Zusammenfassen"
                onclick="setAction('zusammenfassen')">üìù</button>
        <button class="action-button" data-tooltip="Antworten"
                onclick="setAction('antworten')">‚úâÔ∏è</button>
        <button class="action-button" data-tooltip="√úbersetzen"
                onclick="setAction('√ºbersetzen')">üåê</button>
        <button class="action-button" data-tooltip="Freier Modus"
                onclick="setAction('freierModus')">üîß</button>
      </div>

      <div class="settings-modal" id="settingsModal">
        <div class="form-group">
          <label for="modeSelect">Verarbeitung:</label>
          <select id="modeSelect" onchange="updateSettings()">
            <option value="azure">‚ö° Schnell (Azure)</option>
            <option value="ollama">üîí Datenschutz (Ollama)</option>
          </select>
        </div>
        <div class="form-group" id="toneGroup" style="display:none">
          <label for="toneSelect">Tonfall:</label>
          <select id="toneSelect">
            <option value="formell">Formell</option>
            <option value="informell">Informell</option>
            <option value="h√∂flich">H√∂flich</option>
            <option value="direkt">Direkt & pr√§gnant</option>
          </select>
        </div>
        <div class="form-group" id="greetingGroup" style="display:none">
          <label for="greetingSelect">Anrede:</label>
          <select id="greetingSelect">
            <option value="informell">Du</option>
            <option value="formell">Sie</option>
          </select>
        </div>
        <div class="form-group" id="lengthGroup" style="display:none">
          <label for="lengthSelect">L√§nge:</label>
          <select id="lengthSelect">
            <option value="kurz">Kurz</option>
            <option value="mittel">Mittel</option>
            <option value="lang">Lang</option>
          </select>
        </div>
        <div class="form-group" id="languageGroup" style="display:none">
          <label for="languageSelect">Zielsprache:</label>
          <select id="languageSelect">
            <option value="deutsch">Deutsch</option>
            <option value="englisch">Englisch</option>
            <option value="franz√∂sisch">Franz√∂sisch</option>
            <option value="italienisch">Italienisch</option>
          </select>
        </div>
        <button class="send-button" onclick="handleSubmitFromModal()">Ausf√ºhren</button>
        <button class="send-button" onclick="closeSettings()">Schlie√üen</button>
      </div>
    </div>

    <script>
      function showPopup(message) {
        const p = document.getElementById("customPopup");
        document.getElementById("popupContent").innerHTML = message;
        p.style.display = "flex";
      }
      function hidePopup() {
        document.getElementById("customPopup").style.display = "none";
      }

      const errorDiv = document.getElementById("error");
      const actionButton = document.getElementById("actionButton");
      const settingsModal = document.getElementById("settingsModal");
      const emailSummaryDiv = document.getElementById("emailSummary");
      const lottieLoader = document.getElementById("lottieLoader");
      const lottieHeaderLoading = document.getElementById("lottieHeaderLoading");
      const lottieHeaderReady   = document.getElementById("lottieHeaderReady");

      let emailContent = "", emailSubject = "", emailSender = "";
      let mode="azure", action="antworten", tone="formell",
          language="deutsch", greeting="informell", length="kurz";
      let isContentLoaded=false;

      function logError(msg) {
        console.error(msg);
        errorDiv.innerText = msg;
        errorDiv.classList.add("active");
      }
      function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
      }
      function openSettings() {
        if (!isContentLoaded) return;
        settingsModal.classList.add("active");
        document.getElementById("modeSelect").value = mode;
        updateSettings();
      }
      function closeSettings() {
        settingsModal.classList.remove("active");
      }
      function mapLanguage(l) {
        const m={deutsch:"German",englisch:"English",franz√∂sisch:"French",italienisch:"Italian"};
        return m[l]||l;
      }
      function setAction(a) {
        action=a;
        actionButton.textContent = a==="zusammenfassen"?"Zusammenfassen":
                                  a==="antworten"?"Antwort formulieren":
                                  a==="√ºbersetzen"?"√úbersetzen":"Freier Modus";
        if(isContentLoaded) actionButton.disabled=false;
        updateSettings();
      }
      function updateSettings() {
        mode=document.getElementById("modeSelect").value;
        document.getElementById("toneGroup").style.display = action==="antworten"?"block":"none";
        document.getElementById("greetingGroup").style.display = action==="antworten"?"block":"none";
        document.getElementById("lengthGroup").style.display = action==="antworten"?"block":"none";
        document.getElementById("languageGroup").style.display = action==="√ºbersetzen"?"block":"none";
        if(action==="antworten"){
          tone=document.getElementById("toneSelect").value;
          greeting=document.getElementById("greetingSelect").value;
          length=document.getElementById("lengthSelect").value;
        } else if(action==="√ºbersetzen"){
          language=mapLanguage(document.getElementById("languageSelect").value);
        }
      }
      function toggleSummary(){
        if(emailSummaryDiv.style.display==="none"){
          emailSummaryDiv.style.display="block";
          document.getElementById("toggleSummaryButton").innerText="Zusammenfassung verbergen";
        } else {
          emailSummaryDiv.style.display="none";
          document.getElementById("toggleSummaryButton").innerText="Zusammenfassung anzeigen";
        }
      }
      function copyOutputContent(){
        navigator.clipboard.writeText(document.getElementById("output").innerText).catch(()=>{});
      }

      async function callAzure(prompt){
        try {
          const res = await fetch(
            "https://openaiaddinapi.openai.azure.com/openai/deployments/gpt-4o_MailAiderAi_OutlookAddIn/chat/completions?api-version=2025-01-01-preview", {
              method:"POST",
              headers:{
                "Content-Type":"application/json",
                "api-key":"YOUR_KEY_HERE"
              },
              body:JSON.stringify({
                messages:[
                  {role:"system",content:"Du bist ein E-Mail-Assistent..."},
                  {role:"user",content:prompt}
                ],
                temperature:0.6
              })
            }
          );
          const data = await res.json();
          return data.choices?.[0]?.message?.content || "‚ùå Keine Antwort erhalten.";
        } catch(e){
          return "‚ùå Fehler bei Azure: "+e.message;
        }
      }
      async function callLokal(prompt){
        try {
          const res = await fetch("http://localhost:11434/api/chat",{
            method:"POST", headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
              model:"nous-hermes2",
              messages:[
                {role:"system",content:"Du bist professioneller E-Mail-Assistent..."},
                {role:"user",content:prompt}
              ],
              stream:false
            })
          });
          const d = await res.json();
          return d.message?.content || "‚ùå Keine Antwort erhalten.";
        } catch(e){
          return "‚ùå Fehler bei Lokal: "+e.message;
        }
      }

      async function handleSubmitFromModal(){
        const promptInput = document.getElementById("promptInput").value;
        const outputDiv = document.getElementById("output");
        const emailText = emailContent ? `Kontext: ${emailContent}\n` : "";
        let fullPrompt = promptInput;
        if(!emailContent && !promptInput){
          outputDiv.innerText="‚ùå Kein E-Mail-Inhalt oder Benutzertext verf√ºgbar.";
          return;
        }
        if(action==="zusammenfassen"){
          fullPrompt = `Fasse die E-Mail in Stichpunkten zusammen:\n\n${emailText}${promptInput}`;
        } else if(action==="antworten"){
          fullPrompt = `Formuliere eine Antwort im ${tone} Ton mit ${greeting} Anrede (${length}):\n${emailText}${promptInput}`;
        } else if(action==="√ºbersetzen"){
          fullPrompt = `√úbersetze ins ${language}:\n${emailText}${promptInput}`;
        }
        // Show loaders
        lottieHeaderLoading.style.display="block";
        lottieHeaderReady.style.display="none";
        lottieLoader.style.display="block";
        // Call API
        const response = await (mode==="azure"?callAzure:callLokal)(fullPrompt);
        // Hide loaders, show ready
        lottieLoader.style.display="none";
        lottieHeaderLoading.style.display="none";
        lottieHeaderReady.style.display="block";
        outputDiv.innerText = response;
      }

      async function summarizeEmail(){
        if(!emailContent) return;
        const p = `Fasse E-Mail in max.4 Stichpunkten zusammen:\n\n${emailContent}`;
        const res = await callAzure(p);
        emailSummaryDiv.innerText = res;
      }

      Office.onReady((info)=>{
        if(!Office.context.mailbox?.item){
          logError("Kein E-Mail-Kontext verf√ºgbar.");
          return;
        }
        const item = Office.context.mailbox.item;
        // Load subject/sender
        if(info.platform==="OfficeOnline"){
          emailSubject = item.subject || "Kein Betreff";
          document.getElementById("emailSubject").innerText = emailSubject;
          emailSender = item.from?.displayName||item.from?.emailAddress||"Unbekannter Absender";
          document.getElementById("emailSender").innerText = "Von: "+emailSender;
        } else {
          item.subject.getAsync((r)=>{ if(r.status==="succeeded"){
            document.getElementById("emailSubject").innerText = r.value;
          }});
          item.from.getAsync((r)=>{ if(r.status==="succeeded"){
            document.getElementById("emailSender").innerText = "Von: "+(r.value.displayName||r.value.emailAddress);
          }});
        }
        item.body.getAsync("text",(r)=>{
          if(r.status==="succeeded"){
            emailContent = r.value;
            summarizeEmail().then(()=>{
              isContentLoaded=true;
              actionButton.disabled=false;
              // initial ready icon
              lottieHeaderReady.style.display="block";
            });
          } else logError("Fehler beim Laden: "+r.error.message);
        });
      }).catch(e=>logError("Office.js Fehler: "+e.message));
    </script>
  </body>
</html>
